<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pause & Play: Rumbo a la Cima</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root { color-scheme: dark; }
      body { background: linear-gradient(to bottom, #111827, #0b0f19, #000); color: #fff; }
      .card { border: 1px solid #374151; background: rgba(31,41,55,0.7); border-radius: 1rem; }
      .progress { height: 8px; border-radius: 9999px; background: #374151; overflow: hidden }
      .progress > div { height: 100%; background: #ef4444; transition: width .25s ease; }
      .btn { border-radius: .75rem; font-weight: 600; padding: .6rem 1rem; }
      .btn-primary { background: #dc2626; } .btn-primary:hover { background: #b91c1c; }
      .btn-secondary { background: #374151; } .btn-outline { border: 1px solid #4b5563; }
      .btn-outline:hover { border-color: #ef4444; }
      .btn:disabled { opacity:.5; cursor:not-allowed; }
      .opt-picked { border-color:#f87171 !important; background:rgba(239,68,68,.08) !important; }
      .delta-badge { font-size:.70rem; padding:.12rem .4rem; border-radius:.45rem; display:inline-flex; gap:.3rem; align-items:center; }
      .delta-up   { color:#22c55e; background:rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.35); }
      .delta-down { color:#ef4444; background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); }
      .fade-in { animation: fadein .25s ease-out; }
      @keyframes fadein { from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:translateY(0)} }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/framer-motion/dist/framer-motion.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div class="p-6 md:p-10"><div id="root"></div></div>

    <script type="text/babel" data-presets="react">
      const FM = window['framer-motion'] || {};
      const {motion, AnimatePresence} = FM;
      const { useState, useMemo, useEffect } = React;
      const clamp = (v, min=0, max=100) => Math.max(min, Math.min(max, v));
      const rnd = (n) => Math.round(n);

      /* ========= HUD con animaci√≥n y deltas ========= */
      const ProgressBar = ({ value=0, color='#ef4444' }) => {
        const v = clamp(Math.round(value), 0, 100);
        return <div className="progress w-full"><div style={{width: v+'%', background: color}}></div></div>;
      };
      function Metric({label, val, color, delta}) {
        const showDelta = delta && Math.abs(delta) >= 1;
        const up = delta>0, down = delta<0;
        return (
          <div className="bg-gray-800/50 rounded-xl p-3 text-center">
            <div className="text-[11px] text-gray-400 tracking-wide">{label}</div>
            <div className="text-xl font-bold" style={{color}}>{clamp(val,0,100)}%</div>
            {showDelta && (
              <div className={`delta-badge mt-1 inline-flex fade-in ${up?'delta-up':'delta-down'}`}>
                <span>{up?'‚ñ≤':'‚ñº'}</span>
                <span>{Math.abs(rnd(delta))}%</span>
              </div>
            )}
          </div>
        );
      }
      function HUD({ omni, risk, margin, satisfaction, popularity, online, sala, deltas }) {
        const items = [
          {label:'Omnicanalidad',val:rnd(omni),color:'#60a5fa',k:'omni'},
          {label:'Riesgo',val:rnd(risk),color:'#ef4444',k:'risk'},
          {label:'Margen',val:rnd(margin),color:'#10b981',k:'margin'},
          {label:'Satisfacci√≥n',val:rnd(satisfaction),color:'#f97316',k:'satisfaction'},
          {label:'Popularidad',val:rnd(popularity),color:'#eab308',k:'popularity'},
          {label:'Online',val:rnd(online),color:'#34d399',k:'online'},
          {label:'Sala',val:rnd(sala),color:'#a78bfa',k:'sala'},
        ];
        return (
          <div className="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-7 gap-3">
            {items.map((m) => <Metric key={m.k} label={m.label} val={m.val} color={m.color} delta={deltas[m.k]||0} />)}
          </div>
        );
      }

      /* ============== Mapa etapas ============== */
      function StageMap({ current }) {
        const points = [
          {x:80,y:260},{x:240,y:220},{x:400,y:260},{x:560,y:210},{x:720,y:160},{x:880,y:90}
        ];
        const pathD = `M ${points[0].x},${points[0].y}
          C 160,240 200,220 ${points[1].x},${points[1].y}
          S ${points[2].x},${points[2].y} ${points[3].x},${points[3].y}
          S ${points[4].x},${points[4].y} ${points[5].x},${points[5].y}`;
        return (
          <svg viewBox="0 0 980 320" className="w-full h-[260px] md:h-[320px]">
            <path d={pathD} fill="none" stroke="#64748b" strokeWidth="6" strokeLinecap="round" opacity="0.5"/>
            {points.map((p,i)=>(
              <g key={i} transform={`translate(${p.x} ${p.y})`}>
                <circle r="28" fill={i<=current ? "#ef4444" : "#475569"} />
                <text textAnchor="middle" y="6" fontSize="18" fill="#fff" fontWeight="700">{i}</text>
              </g>
            ))}
          </svg>
        );
      }

      function Board({ level, levelIndex, state, success, onOpenScenario, toast }) {
        return (
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 card relative">
              <div className="p-8">
                <h1 className="text-4xl md:text-5xl font-extrabold tracking-tight">
                  PAUSE &amp; PLAY: <span className="text-red-400">Rumbo a la Cima</span>
                </h1>
                <div className="mt-2 text-gray-300 flex items-center gap-3">
                  <span className="text-2xl">{level.icon}</span>
                  <div><div className="text-2xl md:text-3xl font-bold">{level.title}</div></div>
                </div>
                <div className="mt-4"><StageMap current={levelIndex}/></div>
                <div className="mt-2"><button className="btn btn-primary" onClick={onOpenScenario}>Abrir escenarios</button></div>
              </div>
              <AnimatePresence>
                {toast && (
                  <motion.div
                    key="toast"
                    initial={{opacity:0, y:-10}} animate={{opacity:1, y:0}} exit={{opacity:0, y:-10}}
                    transition={{duration:.25}}
                    className="absolute top-3 left-3 right-3 mx-3 bg-emerald-500/15 border border-emerald-400 text-emerald-300 rounded-xl p-3 text-sm"
                  >
                    {toast}
                  </motion.div>
                )}
              </AnimatePresence>
            </div>

            <div className="flex flex-col gap-6">
              <div className="card">
                <div className="p-6">
                  <div className="text-5xl font-extrabold">{success}</div>
                  <div className="text-sm text-gray-300/90 mt-1">√âxito del Casino (0‚Äì100)</div>
                  <div className="mt-3"><ProgressBar value={success} color="#f59e0b" /></div>
                </div>
              </div>

              <div className="card">
                <div className="p-4" id="hud-slot"></div>
              </div>
            </div>
          </div>
        );
      }

      const FinalScreen = ({ score, stats, onRestart }) => (
        <div className="card">
          <div className="text-center space-y-4 py-12 px-6">
            <div className="text-5xl">üèÅ</div>
            <h2 className="text-3xl md:text-4xl font-extrabold text-red-400">¬°Cima alcanzada!</h2>
            <p className="text-gray-200 text-lg">Puntuaci√≥n final: <span className="font-bold">{score}</span></p>
            <div className="grid md:grid-cols-3 gap-3 text-sm text-gray-200 max-w-3xl mx-auto">
              <div className="bg-white/5 p-3 rounded-xl">Omnicanalidad: <b>{rnd(stats.omni)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Satisfacci√≥n: <b>{rnd(stats.satisfaction)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Riesgo: <b>{rnd(stats.risk)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Margen: <b>{rnd(stats.margin)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Popularidad: <b>{rnd(stats.popularity)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Online: <b>{rnd(stats.online)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Sala: <b>{rnd(stats.sala)}%</b></div>
            </div>
            <div className="flex justify-center gap-4 mt-4"><button className="btn btn-secondary" onClick={onRestart}>üîÅ Reiniciar</button></div>
          </div>
        </div>
      );

      /* ============== CONTENIDO (igual que versi√≥n previa) ============== */
      const LEVELS = [
        {
          key:"e0", icon:"üèïÔ∏è", title:"Etapa 0 ‚Äî Captaci√≥n", jump:"+1 mes",
          blocks:[
            { type:"scenarios", heading:"Escenarios (bases de decisi√≥n):",
              scenarios:[
                { title:"Estrategias de captaci√≥n.", desc:"V√≠as de captaci√≥n de clientes para el Casino:",
                  options:[
                    { text:"Campa√±as SEO + SEM.", impact:{ popularity:+6, risk:+4, margin:-4, satisfaction:+2, online:+8, omni:-2 } },
                    { text:"Acuerdos con Streamers.", impact:{ popularity:+20, risk:+10, margin:-10, online:+6, omni:-10 }, key:true },
                    { text:"Campa√±as de registro desde los locales.", impact:{ sala:+8, omni:+6, risk:+2, margin:+2, popularity:+3 } },
                  ]},
                { title:"Promoci√≥n de bienvenida.", desc:"Promoci√≥n que utilizaremos para potenciar los registros:",
                  options:[
                    { text:"200% de primer dep√≥sito.", impact:{ margin:-10, risk:+8, popularity:+8, satisfaction:+2, omni:-3 } },
                    { text:"20‚Ç¨ sin dep√≥sito.", impact:{ popularity:+10, risk:+10, margin:-8, satisfaction:+3, online:+4, omni:-2 } },
                    { text:"Sin bono (Marca premium).", impact:{ margin:+8, satisfaction:-6, popularity:-6, risk:-4 } },
                  ]},
              ]
            },
            { type:"event", heading:"Evento exclusivo:", title:"¬°Necesitamos registros!",
              desc:"Quieres hacer push para potenciar registros durante un mes:",
              scenarios:[{ title:"", options:[
                { text:"Competici√≥n de registros desde los locales con Ranking.", impact:{ omni:+15, sala:+10, margin:-5, popularity:+6 }, key:true },
                { text:"Campa√±a de Twitch con Streamer TOP.", impact:{ popularity:+18, risk:+8, margin:-8, omni:-8, online:+8 } },
                { text:"Sin evento (Ahorro).", impact:{ margin:+5, popularity:-4 } },
              ]}]
            },
          ]
        },
        {
          key:"e1", icon:"‚ö°", title:"Etapa 1 ‚Äî Activaci√≥n", jump:"+3 meses",
          blocks:[
            { type:"scenarios", heading:"Escenarios:",
              scenarios:[
                { title:"Clientes registrados sin verificaci√≥n.", desc:"El 45% de los nuevos registros no han completado su verificaci√≥n:",
                  options:[
                    { text:"Bloqueo de cuenta hasta su verificaci√≥n.", impact:{ risk:-8, satisfaction:-8, margin:+4, omni:-2 } },
                    { text:"Activar promociones √∫nicamente para clientes verificados.", impact:{ risk:-10, satisfaction:+4, margin:-4 } },
                    { text:"No intervenir y esperar acci√≥n del cliente.", impact:{ risk:+10, satisfaction:-10 } },
                  ]},
                { title:"Clientes activos sin primer dep√≥sito.", desc:"Los jugadores han jugado en modo demo o navegan por la app, pero a√∫n no depositan:",
                  options:[
                    { text:"Estrategia de mailing con bono de bienvenida.", impact:{ popularity:+4, margin:-4, satisfaction:+2, online:+4, risk:+3 } },
                    { text:"Crear campa√±a agresiva de urgencia: ‚ÄúDeposita hoy y obt√©n un 300% de tu primer dep√≥sito‚Äù.", impact:{ margin:-20, risk:+15, popularity:+10, omni:-5 }, key:true },
                    { text:"Campa√±a de llamadas desde Atenci√≥n al Cliente + Sala con promoci√≥n exclusiva.", impact:{ omni:+8, sala:+8, satisfaction:+6, margin:-8, risk:+4 } },
                    { text:"No intervenir y esperar acci√≥n del cliente.", impact:{ satisfaction:-6, popularity:-4 } },
                  ]},
              ]
            },
            { type:"event", heading:"Evento exclusivo:", title:"Fallo en la web",
              desc:"Durante la campa√±a de activaci√≥n, Alira se cae durante 4 horas. Los usuarios no pueden completar su verificaci√≥n ni acceder al bono:",
              scenarios:[{ title:"", options:[
                { text:"Comunicar en web y publicar promoci√≥n en compensaci√≥n.", impact:{ satisfaction:+10, margin:-6, risk:-4, omni:+2 } },
                { text:"Enviar promoci√≥n √∫nicamente a clientes molestos que presenten quejas.", impact:{ satisfaction:+4, margin:-3, risk:-2 } },
                { text:"Ignorar el problema y priorizar la campa√±a una vez se reanude.", impact:{ satisfaction:-20, risk:+10 }, key:true },
              ]}]
            },
          ]
        },
        {
          key:"e2", icon:"üîÅ", title:"Etapa 2 ‚Äî Retenci√≥n", jump:"+6 meses",
          blocks:[
            { type:"scenarios", heading:"Escenarios:",
              scenarios:[
                { title:"Ca√≠da de actividad tras el primer dep√≥sito.", desc:"Detectas una bajada del rendimiento tras una gran campa√±a de activaci√≥n:",
                  options:[
                    { text:"Campa√±a para invitar a los clientes a una fiesta de Casino Online en los locales Pause&Play.", impact:{ sala:+10, omni:+8, popularity:+6, margin:-8, satisfaction:+8 } },
                    { text:"Redise√±o de la web para darle otro enfoque.", impact:{ satisfaction:+8, online:+6, margin:-6 }, _defer:{after:1,msg:"El redise√±o empieza a convertir mejor: +4% margen, +2% satisfacci√≥n.", impact:{margin:+4, satisfaction:+2}} },
                    { text:"Lanzamiento de la APP CasinoPause&Play (requiere inversi√≥n alta pero mejora experiencia a largo plazo).", impact:{ satisfaction:+20, online:+15, omni:+10, margin:-10 }, key:true, _defer:{after:2,msg:"La APP tracciona: +12% margen, +6% online, +4% satisfacci√≥n.", impact:{margin:+12, online:+6, satisfaction:+4}} },
                  ]},
                { title:"Baja participaci√≥n de los clientes en promociones semanales.", desc:"El calendario de promociones online no tiene buena acogida en jugadores regulares. El ROI de las campa√±as est√° cayendo y se eval√∫a c√≥mo reactivar el inter√©s:",
                  options:[
                    { text:"Segmentar las promociones por valor para hacerlas m√°s atractivas.", impact:{ satisfaction:+8, margin:-4, risk:-2, omni:+4 } },
                    { text:"Duplicar las promociones durante un tiempo para incentivar su uso.", impact:{ popularity:+10, satisfaction:+6, margin:-10, risk:+6 } },
                    { text:"Crear nuevos formatos (desaf√≠os semanales, minijuegos propios, ...).", impact:{ popularity:+8, satisfaction:+8, online:+6, margin:-6 } },
                  ]},
              ]
            },
            { type:"event", heading:"Evento exclusivo:", title:"Nuevo Lanzamiento",
              desc:"Un proveedor TOP nos elige para darnos en exclusiva su lanzamiento m√°s esperado del a√±o:",
              scenarios:[{ title:"", options:[
                { text:"Lanzar campa√±a multicanal durante la semana previa + posicionamiento premium en la web.", impact:{ omni:+15, popularity:+20, risk:+10, margin:-8 }, key:true, _defer:{after:1,msg:"El lanzamiento deja cola larga: +6% margen.", impact:{margin:+6}} },
                { text:"Hacer un lanzamiento anticipado de 2 d√≠as para clientes VIP.", impact:{ satisfaction:+10, popularity:+8, risk:+4, margin:-6 } },
                { text:"Crear una promoci√≥n de FreeSpins exclusiva para clientes de los locales.", impact:{ sala:+8, omni:+6, popularity:+6, margin:-6 } },
              ]}]
            },
          ]
        },
        {
          key:"e3", icon:"‚öñÔ∏è", title:"Etapa 3 ‚Äî Riesgo", jump:"+9 meses",
          blocks:[
            { type:"scenarios", heading:"Escenarios:",
              scenarios:[
                { title:"Jugador intensivo Omnicanal.", desc:"Un cliente con alta actividad tanto en sala como online muestra sesiones muy prolongadas y dep√≥sitos frecuentes. Su comportamiento genera preocupaci√≥n en el equipo:",
                  options:[
                    { text:"Hacer estudio de riesgo y reducir privilegios si estos dan positivo.", impact:{ risk:-20, satisfaction:-5 }, key:true },
                    { text:"Enviar una comunicaci√≥n responsable con informaci√≥n sobre juego seguro.", impact:{ risk:-8, satisfaction:+2 } },
                    { text:"Seguimiento discreto hasta detectar patrones m√°s fuertes y claros.", impact:{ risk:-4 } },
                  ]},
                { title:"Solicitud de exclusi√≥n voluntaria.", desc:"Cliente con alta actividad nos pide tomarse un descanso:",
                  options:[
                    { text:"Bloqueo de cuenta inmediato y pedirle que solicite autoexclusi√≥n por el tiempo que considere.", impact:{ risk:-15, satisfaction:-4 } },
                    { text:"Contactar con √©l para analizar qu√© riesgos manifiesta.", impact:{ risk:-10, satisfaction:+4 }, note:"rgiaj" },
                    { text:"Intento de disuasi√≥n sugiriendo una bajada de l√≠mites y tratar de retrasar el tr√°mite.", impact:{ risk:+15, satisfaction:-15, omni:-5 }, key:true },
                  ]},
              ]
            },
            { type:"event", heading:"Evento exclusivo:", title:"Nueva regulaci√≥n",
              desc:"La DGOJ anuncia una nueva norma que exige avisos de pausa autom√°tica y l√≠mites por defecto m√°s bajos. El equipo debe decidir c√≥mo implementar el cambio antes de la fecha l√≠mite:",
              scenarios:[{ title:"", options:[
                { text:"Adelantar el cumplimiento y aplicar los l√≠mites cuanto antes para estar preparados.", impact:{ risk:-10, satisfaction:+8, omni:+6, margin:-6 } },
                { text:"Plan gradual aplic√°ndolo √∫nicamente a nuevos clientes y luego extenderlo al resto.", impact:{ risk:-6, satisfaction:+4, omni:+3, margin:-3 } },
                { text:"Esperar a la publicaci√≥n oficial y retrasar su aplicaci√≥n hasta el √∫ltimo d√≠a.", impact:{ risk:+20, satisfaction:-15, margin:+10, omni:-10 }, key:true },
              ]}]
            },
          ]
        },
        {
          key:"e4", icon:"üèÜ", title:"Etapa 4 ‚Äî Fidelizaci√≥n", jump:"+1 a√±o",
          blocks:[
            { type:"scenarios", heading:"Escenarios:",
              scenarios:[
                { title:"Club VIP Omnicanal.", desc:"Tras meses de crecimiento digital, se plantea integrar los programas de fidelizaci√≥n de salas f√≠sicas y online bajo una misma marca: Club VIP Omnicanal. El objetivo: unificar beneficios y crear una experiencia continua para los jugadores m√°s valiosos:",
                  options:[
                    { text:"Modelo conjunto. Un solo club con puntos acumulables en ambos canales y beneficios cruzados.", impact:{ omni:+20, satisfaction:+10, margin:-10 }, key:true },
                    { text:"Modelo espejo. Beneficios m√°s fuertes en online para los clientes de sala y beneficios m√°s fuertes en sala para clientes online.", impact:{ omni:+10, satisfaction:+6, margin:-6 } },
                    { text:"Modelo paralelo. Club VIP conjunto pero manteniendo las preferencias de cada cliente.", impact:{ omni:+8, satisfaction:+8, margin:-4 } },
                  ]},
                { title:"Dise√±o de beneficios y recompensas.", desc:"El club necesita una propuesta de valor clara para retener y motivar sin generar dependencia:",
                  options:[
                    { text:"Experiencias exclusivas como viajes, eventos, regalos.", impact:{ satisfaction:+10, popularity:+8, margin:-8 } },
                    { text:"Recompensas web. Mejoras en promociones como cashback, misiones VIP, atenci√≥n personalizada,...", impact:{ satisfaction:+8, popularity:+6, margin:-6, online:+6 } },
                    { text:"Reconocimientos simb√≥licos. Trofeos digitales, distintivos visuales para sus cuentas, comunicaci√≥n preferente,...", impact:{ satisfaction:+6, popularity:+4, margin:-2 } },
                    { text:"Bonificaci√≥n agresiva. Promociones continuas y altos porcentajes de Cashbacks.", impact:{ margin:-20, popularity:+15, risk:+10, omni:-5 }, key:true },
                  ]},
              ]
            },
            { type:"event", heading:"Evento exclusivo:", title:"¬°Quiero mi promoci√≥n!",
              desc:"Un grupo de jugadores regulares (no VIP) se queja en redes sociales por los beneficios exclusivos del club, acusando trato desigual y falta de transparencia:",
              scenarios:[{ title:"", options:[
                { text:"Explicaci√≥n sobre la meritocracia del club y transparencia con criterios de acceso.", impact:{ satisfaction:+4, risk:-2, popularity:-2 } },
                { text:"Abrir una secci√≥n intermedia con categor√≠as (plata/oro) y mejoras de menor nivel.", impact:{ satisfaction:+8, popularity:+6, margin:-6 } },
                { text:"Mantener la exclusividad del club priorizando prestigio y diferenciaci√≥n.", impact:{ popularity:-6, satisfaction:+2, margin:+2 } },
              ]}]
            },
          ]
        },
        {
          key:"e5", icon:"üèîÔ∏è", title:"Etapa 5 ‚Äî Consolidaci√≥n de Marca", jump:"",
          blocks:[
            { type:"scenarios", heading:"Escenarios:",
              scenarios:[
                { title:"Pause&PlayBet.es", desc:"La empresa recibe la licencia de juego AADD para operar apuestas deportivas en Espa√±a. El hito representa un avance clave en la consolidaci√≥n de la marca como operador regulado y omnicanal. El reto ahora es decidir c√≥mo enfocar el lanzamiento para maximizar reputaci√≥n, confianza y crecimiento sostenible:",
                  options:[
                    { text:"Lanzar una nueva marca espec√≠fica para apuestas deportivas, con identidad y p√∫blico propio.", impact:{ popularity:+8, risk:+6, margin:+4, omni:-6 } },
                    { text:"Integrar las apuestas deportivas dentro del casino, manteniendo una marca √∫nica y coherente.", impact:{ omni:+15, risk:+10, margin:+10 }, key:true },
                    { text:"Crear una submarca vinculada (ej. pauseandplaybet.es), con identidad propia pero bajo el paraguas corporativo.", impact:{ omni:+8, popularity:+6, risk:+6, margin:+6 } },
                  ]},
                { title:"Experiencia Total Omnicanal.", desc:"Pause & Play quiere consolidar su modelo omnicanal conectando completamente la experiencia f√≠sica y digital. La direcci√≥n estudia incorporar terminales de apuestas deportivas en los locales, integradas con las cuentas online:",
                  options:[
                    { text:"Instalar terminales en todos los locales y comunicarlo como salto tecnol√≥gico de la marca.", impact:{ omni:+10, sala:+15, risk:+8, margin:-10 }, _defer:{after:1,msg:"Las terminales empiezan a rentabilizarse: +6% margen, +4% sala.", impact:{margin:+6, sala:+4}} },
                    { text:"Probar el modelo en unos pocos centros estrat√©gicos y escalar gradualmente seg√∫n resultados.", impact:{ omni:+6, sala:+8, risk:+4, margin:-4 }, _defer:{after:2,msg:"El piloto madura: +4% margen, +2% sala.", impact:{margin:+4, sala:+2}} },
                    { text:"Priorizar comunidades con mayor madurez digital y permisos favorables para optimizar recursos.", impact:{ omni:+8, sala:+10, risk:+3, margin:-6 } },
                  ]},
              ]
            },
            { type:"event", heading:"Evento exclusivo:", title:"Siguientes pasos",
              desc:"Despu√©s de a√±os de evoluci√≥n, Pause & Play ha alcanzado la cima del sector como operador omnicanal con presencia nacional y licencia AADD. El √©xito es innegable‚Ä¶ pero tambi√©n lo es la responsabilidad de liderar el futuro del entretenimiento regulado. La direcci√≥n debe decidir cu√°l ser√° el rumbo de la compa√±√≠a en esta nueva era:",
              scenarios:[{ title:"", options:[
                { text:"Expandir fronteras. Llevar el modelo Pause & Play a nuevos pa√≠ses, replicando la experiencia omnicanal a nivel internacional.", impact:{ omni:+20, risk:+15, margin:+10 }, key:true },
                { text:"Innovar la experiencia. Apostar por nuevas tecnolog√≠as (IA, VR, streaming) para reinventar el entretenimiento f√≠sico y digital.", impact:{ satisfaction:+15, popularity:+10, margin:-10, risk:+6, omni:+8 } },
                { text:"Diversificar el negocio. Abrir nuevas l√≠neas de ocio bajo el sello Pause & Play.", impact:{ margin:+10, risk:+6, omni:+6, popularity:+6 } },
              ]}]
            },
          ]
        },
      ];

      /* ==== Soft caps / motor y recuperaci√≥n diferida ==== */
      function stageCap(levelIndex) {
        if (levelIndex <= 1) return 90;
        if (levelIndex <= 3) return 94;
        return 97;
      }
      function scalePositive(current, delta, cap) {
        if (delta <= 0) return delta;
        const start = 70;
        let d = delta;
        if (current >= start) {
          const prox = Math.min(1, (current - start) / (cap - start));
          const factor = 1 - 0.75 * prox; // hasta 25%
          d *= Math.max(0.25, factor);
        }
        if (current >= cap) d *= 0.1;
        return d;
      }
      const START = { omni:40, risk:40, margin:50, satisfaction:50, popularity:40, online:30, sala:30 };

      function applyImpactToState(state, impact, levelIndex) {
        const s = { ...state };
        const cap = stageCap(levelIndex);
        const deltas = {omni:0,risk:0,margin:0,satisfaction:0,popularity:0,online:0,sala:0};

        const add = (k, v=0, useCap=true) => {
          if (!v) return;
          const before = s[k];
          if (v > 0 && useCap) s[k] = clamp(s[k] + scalePositive(s[k], v, cap), 0, 100);
          else s[k] = clamp(s[k] + v, 0, 100);
          deltas[k] = s[k] - before;
        };

        add('omni', impact.omni);
        if (impact.risk) {
          const before = s.risk;
          if (impact.risk > 0) s.risk = clamp(s.risk + scalePositive(s.risk, impact.risk, cap), 0, 100);
          else s.risk = clamp(s.risk + impact.risk * 1.1, 0, 100);
          deltas.risk = s.risk - before;
        }
        add('margin', impact.margin);
        add('satisfaction', impact.satisfaction);
        add('popularity', impact.popularity);
        add('online', impact.online);
        add('sala', impact.sala);

        // Efectos cruzados (suaves)
        if ((impact.popularity||0) > 0) { const b=s.risk; s.risk = clamp(s.risk + impact.popularity*0.25, 0, 100); deltas.risk += s.risk - b; }
        if ((impact.satisfaction||0) > 0) { const b=s.margin; s.margin = clamp(s.margin - impact.satisfaction*0.10, 0, 100); deltas.margin += s.margin - b; }
        if ((impact.margin||0) > 0) {
          let b=s.satisfaction; s.satisfaction = clamp(s.satisfaction - impact.margin*0.05, 0, 100); deltas.satisfaction += s.satisfaction - b;
          b=s.popularity; s.popularity = clamp(s.popularity - impact.margin*0.05, 0, 100); deltas.popularity += s.popularity - b;
        }

        // Ajuste omni por equilibrio online/sala (capado)
        const gap = Math.abs(s.online - s.sala);
        let balanceAdj = Math.max(-3, Math.min(3, 3 - gap * 0.10));
        if (balanceAdj !== 0) {
          const b = s.omni;
          if (balanceAdj > 0) s.omni = clamp(s.omni + scalePositive(s.omni, balanceAdj, cap), 0, 100);
          else s.omni = clamp(s.omni + balanceAdj, 0, 100);
          deltas.omni += s.omni - b;
        }

        // No permitir 100% antes del final
        if (levelIndex < 4) {
          s.omni = Math.min(s.omni, cap);
          s.risk = Math.min(s.risk, cap);
        }

        // Suelo de margen
        if (s.margin < 10) { deltas.margin += (10 - s.margin); s.margin = 10; }

        return {state:s, deltas};
      }

      /* ============== UI Escenarios / Eventos ============== */
      function ScenarioCard({ blockTitle, sc, onChoose, selectedIndex }) {
        return (
          <div className="card">
            <div className="p-6 space-y-4">
              <p className="text-sm text-gray-300/90 uppercase tracking-wider">{blockTitle}</p>
              <h3 className="text-2xl md:text-3xl font-semibold text-red-400">{sc.title}</h3>
              {sc.desc && <p className="text-gray-200/90">{sc.desc}</p>}
              <div className="grid md:grid-cols-2 gap-3">
                {sc.options.map((opt, i) => {
                  const picked = selectedIndex === i;
                  return (
                    <button
                      key={i}
                      className={`btn btn-outline text-left ${picked ? 'opt-picked' : ''}`}
                      disabled={selectedIndex !== null && !picked}
                      onClick={() => onChoose(opt, i)}
                    >
                      {opt.text} {picked && '‚úì'}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }

      function EventModal({ block, onChoose, onClose }) {
        if (!block) return null;
        const ev = block;
        return (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
            <div className="w-full max-w-xl">
              <div className="card" style={{borderColor:'#f59e0b'}}>
                <div className="p-6">
                  <h3 className="text-xl md:text-2xl font-bold text-yellow-400">
                    <span className="text-gray-300">{ev.heading}</span> <i>{ev.title}</i>
                  </h3>
                  <p className="text-gray-200 mt-2">{ev.desc}</p>
                  <div className="grid gap-3 mt-4">
                    {ev.scenarios[0].options.map((opt, i) => (
                      <button key={i} className="btn btn-secondary text-left" style={{background:'#f59e0b',color:'#000'}} onClick={() => onChoose(opt)}>
                        {opt.text}
                      </button>
                    ))}
                  </div>
                  <div className="mt-3">
                    <button className="btn btn-outline" onClick={onClose}>Cerrar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      /* =================== App =================== */
      function App() {
        const [screen, setScreen] = useState('board');
        const [levelIndex, setLevelIndex] = useState(0);
        const [blockIndex, setBlockIndex] = useState(0);
        const [scenarioIndex, setScenarioIndex] = useState(0);
        const [selectedIndex, setSelectedIndex] = useState(null);
        const [eventOpen, setEventOpen] = useState(false);
        const [toast, setToast] = useState("");
        const [pending, setPending] = useState([]); // efectos diferidos
        const [deltas, setDeltas] = useState({omni:0,risk:0,margin:0,satisfaction:0,popularity:0,online:0,sala:0});
        const [showJump, setShowJump] = useState(false);
        const [jumpLabel, setJumpLabel] = useState("");
        const [state, setState] = useState({ ...START });
        const [notes, setNotes] = useState([]);

        const level = LEVELS[levelIndex];

        const success = useMemo(() =>
          Math.round(
            state.margin*0.25 + state.satisfaction*0.25 + state.omni*0.25 +
            (100 - state.risk)*0.15 + state.popularity*0.05 + (state.online+state.sala)/2*0.05
          ), [state]
        );

        // Render HUD (portaled manual para simplificar)
        useEffect(() => {
          const slot = document.getElementById('hud-slot');
          if (slot) ReactDOM.render(
            <HUD {...state} deltas={deltas} />,
            slot
          );
        }, [state, deltas]);

        // Limpia deltas tras mostrar animaci√≥n
        useEffect(() => {
          if (Object.values(deltas).some(v=>v!==0)) {
            const t = setTimeout(() => setDeltas({omni:0,risk:0,margin:0,satisfaction:0,popularity:0,online:0,sala:0}), 1500);
            return () => clearTimeout(t);
          }
        }, [deltas]);

        const currentBlock = level.blocks[blockIndex];
        const scenariosArr = currentBlock?.type === 'scenarios' ? currentBlock.scenarios : null;
        const currentScenario = scenariosArr ? scenariosArr[scenarioIndex] : null;

        // Aplica impacto + registra dif. Si hay _defer, programarlo.
        const applyOption = (opt) => {
          const {state:ns, deltas:dd} = applyImpactToState(state, opt.impact || {}, levelIndex);
          setState(ns); setDeltas(dd);
          if (opt._defer) {
            setPending(p => [...p, { trigger: levelIndex + (opt._defer.after||1), impact: opt._defer.impact||{}, msg: opt._defer.msg||"Resultados positivos de la acci√≥n previa." }]);
          }
        };

        const pickOption = (opt, idx) => {
          if (selectedIndex !== null) return;
          setSelectedIndex(idx);
          applyOption(opt);
          if (opt.note === 'rgiaj' && !notes.includes('rgiaj')) setNotes([...notes, 'rgiaj']);
        };

        const next = () => {
          if (currentBlock?.type === 'scenarios') {
            if (scenarioIndex + 1 < currentBlock.scenarios.length) {
              setScenarioIndex(scenarioIndex + 1);
              setSelectedIndex(null);
              return;
            }
            if (blockIndex + 1 < level.blocks.length) {
              const nextBlock = level.blocks[blockIndex + 1];
              if (nextBlock.type === 'event') { setEventOpen(true); return; }
              setBlockIndex(blockIndex + 1); setScenarioIndex(0); setSelectedIndex(null); return;
            }
          }
          finishLevel();
        };

        const processDeferredFor = (targetIndex) => {
          const now = []; const later = [];
          pending.forEach(e => (e.trigger === targetIndex ? now.push(e) : later.push(e)));
          if (now.length) {
            // Aplica impactos acumulados
            let merged = {omni:0,risk:0,margin:0,satisfaction:0,popularity:0,online:0,sala:0};
            let msg = now.map(e => e.msg).join(" ");
            now.forEach(e => { const {state:ns, deltas:dd} = applyImpactToState(state, e.impact, targetIndex); Object.keys(merged).forEach(k => merged[k]+=dd[k]||0); setState(ns); });
            setDeltas(merged);
            setToast(msg);
            setTimeout(()=>setToast(""), 2500);
          }
          setPending(later);
        };

        const finishLevel = () => {
          if (level.jump) { setJumpLabel(`üìÖ ${level.jump}‚Ä¶`); setShowJump(true); setTimeout(() => setShowJump(false), 1200); }
          const more = levelIndex + 1 < LEVELS.length;
          if (more) {
            const nextIndex = levelIndex + 1;
            setTimeout(() => {
              setLevelIndex(nextIndex);
              setBlockIndex(0); setScenarioIndex(0); setSelectedIndex(null); setScreen('board');
              processDeferredFor(nextIndex); // aplica recuperaciones diferidas al entrar
            }, 900);
          } else {
            setTimeout(() => setScreen('final'), 600);
          }
        };

        const afterEventChoose = (opt) => {
          applyOption(opt);
          setEventOpen(false);
          finishLevel();
        };

        const resetGame = () => {
          setScreen('board'); setLevelIndex(0); setBlockIndex(0); setScenarioIndex(0); setSelectedIndex(null);
          setEventOpen(false); setShowJump(false); setJumpLabel(""); setState({ ...START });
          setNotes([]); setPending([]); setToast(""); setDeltas({omni:0,risk:0,margin:0,satisfaction:0,popularity:0,online:0,sala:0});
        };

        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <motion.div initial={{opacity:0,y:-10}} animate={{opacity:1,y:0}}>
                <h2 className="text-xl md:text-2xl font-semibold text-gray-300">Demo Jugable</h2>
              </motion.div>
              <div className="flex items-center gap-3">
                <button className="btn btn-secondary text-sm" onClick={resetGame}>Reiniciar</button>
                <button className={`btn btn-primary text-sm ${screen==='board'?'opacity-60':''}`} onClick={()=>setScreen('board')}>Tablero</button>
                <button className={`btn btn-primary text-sm ${screen==='scenario'?'opacity-60':''}`} onClick={()=>setScreen('scenario')}>Escenarios</button>
              </div>
            </div>

            <AnimatePresence mode="wait">
              {screen === 'board' && (
                <Board
                  level={level}
                  levelIndex={levelIndex}
                  state={state}
                  success={success}
                  onOpenScenario={()=>setScreen('scenario')}
                  toast={toast}
                />
              )}

              {screen === 'scenario' && currentBlock?.type === 'scenarios' && currentScenario && (
                <div>
                  <div className="card mb-4">
                    <div className="p-6">
                      <h2 className="text-2xl md:text-3xl font-bold mb-2">{level.icon} {level.title}</h2>
                      <p className="text-sm text-gray-300">{currentBlock.heading}</p>
                    </div>
                  </div>

                  <ScenarioCard
                    blockTitle={currentBlock.heading}
                    sc={currentScenario}
                    onChoose={pickOption}
                    selectedIndex={selectedIndex}
                  />

                  <div className="mt-3">
                    <HUD {...state} deltas={deltas} />
                  </div>

                  {selectedIndex!==null && (
                    <div className="flex justify-center mt-4">
                      <button className="btn btn-primary" onClick={next}>Continuar ‚ñ∂</button>
                    </div>
                  )}
                </div>
              )}

              {screen === 'final' && (<FinalScreen score={success} stats={state} onRestart={resetGame} />)}
            </AnimatePresence>

            {eventOpen && currentBlock?.type !== 'event' && (
              <EventModal
                block={LEVELS[levelIndex].blocks.find(b=>b.type==='event')}
                onChoose={afterEventChoose}
                onClose={()=>{ setEventOpen(false); finishLevel(); }}
              />
            )}

            {notes.includes('rgiaj') && (
              <div className="mt-4 p-4 rounded-xl border bg-yellow-50/10 text-yellow-200 text-sm">
                NOTA EXTRA: El cliente informa que su situaci√≥n es delicada y se inscribe en el RGIAJ.
              </div>
            )}

            {showJump && (
              <motion.div className="fixed inset-0 flex items-center justify-center bg-black/80 text-3xl md:text-4xl font-bold text-red-400 z-50"
                          initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} transition={{ duration: 1.0 }}>
                {jumpLabel}
              </motion.div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>

import React, { useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";

/**
 * Pause & Play: Rumbo a la Cima ‚Äî v4
 * - Etapas con textos EXACTOS (sin par√©ntesis) tal como pidi√≥ el usuario
 * - Eliminado LTV
 * - Valores activos: Omnicanalidad, Riesgo, Margen, Satisfacci√≥n, Popularidad, Online, Sala
 * - Sistema de impacto: micro (¬±2‚Äì6), medio (¬±7‚Äì10), clave (¬±15‚Äì25)
 * - Decisiones clave marcadas con `isKey: true`
 * - Algunas elecciones bajan Omnicanalidad para evitar llegar al 100% demasiado r√°pido
 * - Animaci√≥n de calendario al pasar de etapa seg√∫n el guion (+1m, +3m, +6m, +9m, +1y)
 * - NOTA EXTRA (RGIAJ) se muestra condicionalmente cuando procede
 *
 * Nota: Este componente es auto-contenido. Usa Tailwind + Framer Motion.
 */

// ---------- Tipos ----------

type ValueKey =
  | "Omnicanalidad"
  | "Riesgo"
  | "Margen"
  | "Satisfacci√≥n"
  | "Popularidad"
  | "Online"
  | "Sala";

interface Impacts {
  [k: string]: number; // ValueKey -> delta
}

interface ChoiceOption {
  id: string;
  label: string; // Texto visible EXACTO
  impacts: Impacts; // deltas a aplicar
  isKey?: boolean; // decisi√≥n clave (¬±15‚Äì25)
  triggersNoteId?: string; // para mostrar NOTA EXTRA
}

interface Scenario {
  id: string;
  title: string; // T√≠tulo visible EXACTO
  description?: string; // texto de apoyo visible EXACTO
  options: ChoiceOption[];
}

interface Stage {
  id: string;
  icon: string; // emoji de cabecera
  title: string; // visible EXACTO (Etapa X ‚Äî Nombre)
  timeJump?: string; // "+1 mes", "+3 meses", ... para animaci√≥n
  blocks: Array<
    | { type: "scenarios"; heading: string; scenarios: Scenario[] }
    | { type: "event"; heading: string; title: string; description?: string; scenarios: Scenario[] }
  >;
}

// ---------- Datos de juego (textos EXACTOS que ver√°n los jugadores) ----------

const STAGES: Stage[] = [
  {
    id: "etapa0",
    icon: "üèïÔ∏è",
    title: "Etapa 0 ‚Äî Captaci√≥n",
    blocks: [
      {
        type: "scenarios",
        heading: "Escenarios (bases de decisi√≥n):",
        scenarios: [
          {
            id: "e0s1",
            title: "Estrategias de captaci√≥n.",
            description:
              "V√≠as de captaci√≥n de clientes para el Casino:",
            options: [
              {
                id: "seo-sem",
                label: "Campa√±as SEO + SEM.",
                impacts: {
                  Popularidad: 6,
                  Riesgo: 4,
                  Margen: -4,
                  Satisfacci√≥n: 2,
                  Online: 8,
                  Omnicanalidad: -2,
                },
              },
              {
                id: "streamers",
                label: "Acuerdos con Streamers.",
                impacts: {
                  Popularidad: 20,
                  Riesgo: 10,
                  Margen: -10,
                  Omnicanalidad: -10, // baja para equilibrar
                  Online: 6,
                },
                isKey: true,
              },
              {
                id: "locales",
                label: "Campa√±as de registro desde los locales.",
                impacts: {
                  Sala: 8,
                  Omnicanalidad: 6,
                  Riesgo: 2,
                  Margen: 2,
                  Popularidad: 3,
                },
              },
            ],
          },
          {
            id: "e0s2",
            title: "Promoci√≥n de bienvenida.",
            description:
              "Promoci√≥n que utilizaremos para potenciar los registros:",
            options: [
              {
                id: "p200",
                label: "200% de primer dep√≥sito.",
                impacts: {
                  Margen: -10,
                  Riesgo: 8,
                  Popularidad: 8,
                  Satisfacci√≥n: 2,
                  Omnicanalidad: -3,
                },
              },
              {
                id: "20-sin-deposito",
                label: "20‚Ç¨ sin dep√≥sito.",
                impacts: {
                  Popularidad: 10,
                  Riesgo: 10,
                  Margen: -8,
                  Satisfacci√≥n: 3,
                  Online: 4,
                  Omnicanalidad: -2,
                },
              },
              {
                id: "sin-bono",
                label: "Sin bono (Marca premium).",
                impacts: {
                  Margen: 8,
                  Satisfacci√≥n: -6,
                  Popularidad: -6,
                  Riesgo: -4,
                },
              },
            ],
          },
        ],
      },
      {
        type: "event",
        heading: "Evento exclusivo:",
        title: "¬°Necesitamos registros!",
        description:
          "Quieres hacer push para potenciar registros durante un mes:",
        scenarios: [
          {
            id: "e0ev1",
            title: "",
            options: [
              {
                id: "ranking-locales",
                label:
                  "Competici√≥n de registros desde los locales con Ranking.",
                impacts: {
                  Omnicanalidad: 15,
                  Sala: 10,
                  Margen: -5,
                  Popularidad: 6,
                },
                isKey: true,
              },
              {
                id: "twitch-top",
                label: "Campa√±a de Twitch con Streamer TOP.",
                impacts: {
                  Popularidad: 18,
                  Riesgo: 8,
                  Margen: -8,
                  Omnicanalidad: -8,
                  Online: 8,
                },
              },
              {
                id: "sin-evento",
                label: "Sin evento (Ahorro).",
                impacts: {
                  Margen: 5,
                  Popularidad: -4,
                },
              },
            ],
          },
        ],
      },
    ],
  },
  {
    id: "etapa1",
    icon: "‚ö°",
    title: "Etapa 1 ‚Äî Activaci√≥n",
    timeJump: "+1 mes",
    blocks: [
      {
        type: "scenarios",
        heading: "Escenarios:",
        scenarios: [
          {
            id: "e1s1",
            title: "Clientes registrados sin verificaci√≥n.",
            description:
              "El 45% de los nuevos registros no han completado su verificaci√≥n:",
            options: [
              {
                id: "bloqueo-hasta-verificacion",
                label: "Bloqueo de cuenta hasta su verificaci√≥n.",
                impacts: { Riesgo: -8, Satisfacci√≥n: -8, Margen: 4, Omnicanalidad: -2 },
              },
              {
                id: "promos-verificados",
                label:
                  "Activar promociones √∫nicamente para clientes verificados.",
                impacts: { Riesgo: -10, Satisfacci√≥n: 4, Margen: -4 },
              },
              {
                id: "no-intervenir-verif",
                label: "No intervenir y esperar acci√≥n del cliente.",
                impacts: { Riesgo: 10, Satisfacci√≥n: -10 },
              },
            ],
          },
          {
            id: "e1s2",
            title: "Clientes activos sin primer dep√≥sito.",
            description:
              "Los jugadores han jugado en modo demo o navegan por la app, pero a√∫n no depositan:",
            options: [
              {
                id: "mailing-bienvenida",
                label: "Estrategia de mailing con bono de bienvenida.",
                impacts: {
                  Popularidad: 4,
                  Margen: -4,
                  Satisfacci√≥n: 2,
                  Online: 4,
                  Riesgo: 3,
                },
              },
              {
                id: "campania-300",
                label:
                  "Crear campa√±a agresiva de urgencia: ‚ÄúDeposita hoy y obt√©n un 300% de tu primer dep√≥sito‚Äù.",
                impacts: {
                  Margen: -20,
                  Riesgo: 15,
                  Popularidad: 10,
                  Omnicanalidad: -5,
                },
                isKey: true,
              },
              {
                id: "llamadas-sala",
                label:
                  "Campa√±a de llamadas desde Atenci√≥n al Cliente + Sala con promoci√≥n exclusiva.",
                impacts: {
                  Omnicanalidad: 8,
                  Sala: 8,
                  Satisfacci√≥n: 6,
                  Margen: -8,
                  Riesgo: 4,
                },
              },
              {
                id: "no-intervenir-depo",
                label: "No intervenir y esperar acci√≥n del cliente.",
                impacts: { Satisfacci√≥n: -6, Popularidad: -4 },
              },
            ],
          },
        ],
      },
      {
        type: "event",
        heading: "Evento exclusivo:",
        title: "Fallo en la web",
        description:
          "Durante la campa√±a de activaci√≥n, Alira se cae durante 4 horas. Los usuarios no pueden completar su verificaci√≥n ni acceder al bono:",
        scenarios: [
          {
            id: "e1ev1",
            title: "",
            options: [
              {
                id: "compensacion-web",
                label:
                  "Comunicar en web y publicar promoci√≥n en compensaci√≥n.",
                impacts: { Satisfacci√≥n: 10, Margen: -6, Riesgo: -4, Omnicanalidad: 2 },
              },
              {
                id: "promo-clientes-molestos",
                label:
                  "Enviar promoci√≥n √∫nicamente a clientes molestos que presenten quejas.",
                impacts: { Satisfacci√≥n: 4, Margen: -3, Riesgo: -2 },
              },
              {
                id: "ignorar-problema",
                label:
                  "Ignorar el problema y priorizar la campa√±a una vez se reanude.",
                impacts: { Satisfacci√≥n: -20, Riesgo: 10 },
                isKey: true,
              },
            ],
          },
        ],
      },
    ],
  },
  {
    id: "etapa2",
    icon: "üîÅ",
    title: "Etapa 2 ‚Äî Retenci√≥n",
    timeJump: "+3 meses",
    blocks: [
      {
        type: "scenarios",
        heading: "Escenarios:",
        scenarios: [
          {
            id: "e2s1",
            title: "Ca√≠da de actividad tras el primer dep√≥sito.",
            description:
              "Detectas una bajada del rendimiento tras una gran campa√±a de activaci√≥n:",
            options: [
              {
                id: "fiesta-locales",
                label:
                  "Campa√±a para invitar a los clientes a una fiesta de Casino Online en los locales Pause&Play.",
                impacts: {
                  Sala: 10,
                  Omnicanalidad: 8,
                  Popularidad: 6,
                  Margen: -8,
                  Satisfacci√≥n: 8,
                },
              },
              {
                id: "redisenio-web",
                label: "Redise√±o de la web para darle otro enfoque.",
                impacts: { Satisfacci√≥n: 8, Online: 6, Margen: -6 },
              },
              {
                id: "app-casino",
                label:
                  "Lanzamiento de la APP CasinoPause&Play (requiere inversi√≥n alta pero mejora experiencia a largo plazo).",
                impacts: { Satisfacci√≥n: 20, Online: 15, Omnicanalidad: 10, Margen: -10 },
                isKey: true,
              },
            ],
          },
          {
            id: "e2s2",
            title:
              "Baja participaci√≥n de los clientes en promociones semanales.",
            description:
              "El calendario de promociones online no tiene buena acogida en jugadores regulares. El ROI de las campa√±as est√° cayendo y se eval√∫a c√≥mo reactivar el inter√©s:",
            options: [
              {
                id: "segmentar-valor",
                label:
                  "Segmentar las promociones por valor para hacerlas m√°s atractivas.",
                impacts: { Satisfacci√≥n: 8, Margen: -4, Riesgo: -2, Omnicanalidad: 4 },
              },
              {
                id: "duplicar-promos",
                label:
                  "Duplicar las promociones durante un tiempo para incentivar su uso.",
                impacts: { Popularidad: 10, Satisfacci√≥n: 6, Margen: -10, Riesgo: 6 },
              },
              {
                id: "nuevos-formatos",
                label:
                  "Crear nuevos formatos (desaf√≠os semanales, minijuegos propios, ...).",
                impacts: { Popularidad: 8, Satisfacci√≥n: 8, Online: 6, Margen: -6 },
              },
            ],
          },
        ],
      },
      {
        type: "event",
        heading: "Evento exclusivo:",
        title: "Nuevo Lanzamiento",
        description:
          "Un proveedor TOP nos elige para darnos en exclusiva su lanzamiento m√°s esperado del a√±o:",
        scenarios: [
          {
            id: "e2ev1",
            title: "",
            options: [
              {
                id: "multicanal-premium",
                label:
                  "Lanzar campa√±a multicanal durante la semana previa + posicionamiento premium en la web.",
                impacts: { Omnicanalidad: 15, Popularidad: 20, Riesgo: 10, Margen: -8 },
                isKey: true,
              },
              {
                id: "vip-anticipado",
                label:
                  "Hacer un lanzamiento anticipado de 2 d√≠as para clientes VIP.",
                impacts: { Satisfacci√≥n: 10, Popularidad: 8, Riesgo: 4, Margen: -6 },
              },
              {
                id: "freespins-locales",
                label:
                  "Crear una promoci√≥n de FreeSpins exclusiva para clientes de los locales.",
                impacts: { Sala: 8, Omnicanalidad: 6, Popularidad: 6, Margen: -6 },
              },
            ],
          },
        ],
      },
    ],
  },
  {
    id: "etapa3",
    icon: "‚öñÔ∏è",
    title: "Etapa 3 ‚Äî Riesgo",
    timeJump: "+6 meses",
    blocks: [
      {
        type: "scenarios",
        heading: "Escenarios:",
        scenarios: [
          {
            id: "e3s1",
            title: "Jugador intensivo Omnicanal.",
            description:
              "Un cliente con alta actividad tanto en sala como online muestra sesiones muy prolongadas y dep√≥sitos frecuentes. Su comportamiento genera preocupaci√≥n en el equipo:",
            options: [
              {
                id: "estudio-riesgo",
                label:
                  "Hacer estudio de riesgo y reducir privilegios si estos dan positivo.",
                impacts: { Riesgo: -20, Satisfacci√≥n: -5 },
                isKey: true,
              },
              {
                id: "comunicacion-responsable",
                label:
                  "Enviar una comunicaci√≥n responsable con informaci√≥n sobre juego seguro.",
                impacts: { Riesgo: -8, Satisfacci√≥n: 2 },
              },
              {
                id: "seguimiento-discreto",
                label:
                  "Seguimiento discreto hasta detectar patrones m√°s fuertes y claros.",
                impacts: { Riesgo: -4 },
              },
            ],
          },
          {
            id: "e3s2",
            title: "Solicitud de exclusi√≥n voluntaria.",
            description:
              "Cliente con alta actividad nos pide tomarse un descanso:",
            options: [
              {
                id: "bloqueo-inmediato",
                label:
                  "Bloqueo de cuenta inmediato y pedirle que solicite autoexclusi√≥n por el tiempo que considere.",
                impacts: { Riesgo: -15, Satisfacci√≥n: -4 },
              },
              {
                id: "contactar-analizar",
                label:
                  "Contactar con √©l para analizar qu√© riesgos manifiesta. (Si elige esta √∫ltima opci√≥n a√±adir una nota extra).",
                impacts: { Riesgo: -10, Satisfacci√≥n: 4 },
                triggersNoteId: "rgiaj",
              },
              {
                id: "disuasion",
                label:
                  "Intento de disuasi√≥n sugiriendo una bajada de l√≠mites y tratar de retrasar el tr√°mite.",
                impacts: { Riesgo: 15, Satisfacci√≥n: -15, Omnicanalidad: -5 },
                isKey: true,
              },
            ],
          },
        ],
      },
      {
        type: "event",
        heading: "Evento exclusivo:",
        title: "Nueva regulaci√≥n",
        description:
          "La DGOJ anuncia una nueva norma que exige avisos de pausa autom√°tica y l√≠mites por defecto m√°s bajos. El equipo debe decidir c√≥mo implementar el cambio antes de la fecha l√≠mite:",
        scenarios: [
          {
            id: "e3ev1",
            title: "",
            options: [
              {
                id: "adelantar-cumplimiento",
                label:
                  "Adelantar el cumplimiento y aplicar los l√≠mites cuanto antes para estar preparados.",
                impacts: { Riesgo: -10, Satisfacci√≥n: 8, Omnicanalidad: 6, Margen: -6 },
              },
              {
                id: "plan-gradual",
                label:
                  "Plan gradual aplic√°ndolo √∫nicamente a nuevos clientes y luego extenderlo al resto.",
                impacts: { Riesgo: -6, Satisfacci√≥n: 4, Omnicanalidad: 3, Margen: -3 },
              },
              {
                id: "esperar-ultimo-dia",
                label:
                  "Esperar a la publicaci√≥n oficial y retrasar su aplicaci√≥n hasta el √∫ltimo d√≠a.",
                impacts: { Riesgo: 20, Satisfacci√≥n: -15, Margen: 10, Omnicanalidad: -10 },
                isKey: true,
              },
            ],
          },
        ],
      },
      // Nota Extra (se mostrar√° condicionalmente cuando triggersNoteId === 'rgiaj')
    ],
  },
  {
    id: "etapa4",
    icon: "üèÜ",
    title: "Etapa 4 ‚Äî Fidelizaci√≥n",
    timeJump: "+9 meses",
    blocks: [
      {
        type: "scenarios",
        heading: "Escenarios:",
        scenarios: [
          {
            id: "e4s1",
            title: "Club VIP Omnicanal.",
            description:
              "Tras meses de crecimiento digital, se plantea integrar los programas de fidelizaci√≥n de salas f√≠sicas y online bajo una misma marca: Club VIP Omnicanal. El objetivo: unificar beneficios y crear una experiencia continua para los jugadores m√°s valiosos:",
            options: [
              {
                id: "modelo-conjunto",
                label:
                  "Modelo conjunto. Un solo club con puntos acumulables en ambos canales y beneficios cruzados.",
                impacts: { Omnicanalidad: 20, Satisfacci√≥n: 10, Margen: -10 },
                isKey: true,
              },
              {
                id: "modelo-espejo",
                label:
                  "Modelo espejo. Beneficios m√°s fuertes en online para los clientes de sala y beneficios m√°s fuertes en sala para clientes online.",
                impacts: { Omnicanalidad: 10, Satisfacci√≥n: 6, Margen: -6 },
              },
              {
                id: "modelo-paralelo",
                label:
                  "Modelo paralelo. Club VIP conjunto pero manteniendo las preferencias de cada cliente.",
                impacts: { Omnicanalidad: 8, Satisfacci√≥n: 8, Margen: -4 },
              },
            ],
          },
          {
            id: "e4s2",
            title: "Dise√±o de beneficios y recompensas.",
            description:
              "El club necesita una propuesta de valor clara para retener y motivar sin generar dependencia:",
            options: [
              {
                id: "experiencias-exclusivas",
                label:
                  "Experiencias exclusivas como viajes, eventos, regalos.",
                impacts: { Satisfacci√≥n: 10, Popularidad: 8, Margen: -8 },
              },
              {
                id: "recompensas-web",
                label:
                  "Recompensas web. Mejoras en promociones como cashback, misiones VIP, atenci√≥n personalizada,...",
                impacts: { Satisfacci√≥n: 8, Popularidad: 6, Margen: -6, Online: 6 },
              },
              {
                id: "reconocimientos-simbolicos",
                label:
                  "Reconocimientos simb√≥licos. Trofeos digitales, distintivos visuales para sus cuentas, comunicaci√≥n preferente,...",
                impacts: { Satisfacci√≥n: 6, Popularidad: 4, Margen: -2 },
              },
              {
                id: "bonificacion-agresiva",
                label:
                  "Bonificaci√≥n agresiva. Promociones continuas y altos porcentajes de Cashbacks.",
                impacts: { Margen: -20, Popularidad: 15, Riesgo: 10, Omnicanalidad: -5 },
                isKey: true,
              },
            ],
          },
        ],
      },
      {
        type: "event",
        heading: "Evento exclusivo:",
        title: "¬°Quiero mi promoci√≥n!",
        description:
          "Un grupo de jugadores regulares (no VIP) se queja en redes sociales por los beneficios exclusivos del club, acusando trato desigual y falta de transparencia:",
        scenarios: [
          {
            id: "e4ev1",
            title: "",
            options: [
              {
                id: "explicacion-meritocracia",
                label:
                  "Explicaci√≥n sobre la meritocracia del club y transparencia con criterios de acceso.",
                impacts: { Satisfacci√≥n: 4, Riesgo: -2, Popularidad: -2 },
              },
              {
                id: "seccion-intermedia",
                label:
                  "Abrir una secci√≥n intermedia con categor√≠as (plata/oro) y mejoras de menor nivel.",
                impacts: { Satisfacci√≥n: 8, Popularidad: 6, Margen: -6 },
              },
              {
                id: "mantener-exclusividad",
                label:
                  "Mantener la exclusividad del club priorizando prestigio y diferenciaci√≥n.",
                impacts: { Popularidad: -6, Satisfacci√≥n: 2, Margen: 2 },
              },
            ],
          },
        ],
      },
    ],
  },
  {
    id: "etapa5",
    icon: "üèîÔ∏è",
    title: "Etapa 5 ‚Äî Consolidaci√≥n de Marca",
    timeJump: "+1 a√±o",
    blocks: [
      {
        type: "scenarios",
        heading: "Escenarios:",
        scenarios: [
          {
            id: "e5s1",
            title: "Pause&PlayBet.es",
            description:
              "La empresa recibe la licencia de juego AADD para operar apuestas deportivas en Espa√±a. El hito representa un avance clave en la consolidaci√≥n de la marca como operador regulado y omnicanal. El reto ahora es decidir c√≥mo enfocar el lanzamiento para maximizar reputaci√≥n, confianza y crecimiento sostenible:",
            options: [
              {
                id: "nueva-marca",
                label:
                  "Lanzar una nueva marca espec√≠fica para apuestas deportivas, con identidad y p√∫blico propio.",
                impacts: { Popularidad: 8, Riesgo: 6, Margen: 4, Omnicanalidad: -6 },
              },
              {
                id: "integrar-en-casino",
                label:
                  "Integrar las apuestas deportivas dentro del casino, manteniendo una marca √∫nica y coherente.",
                impacts: { Omnicanalidad: 15, Riesgo: 10, Margen: 10 },
                isKey: true,
              },
              {
                id: "submarca-vinculada",
                label:
                  "Crear una submarca vinculada (ej. pauseandplaybet.es), con identidad propia pero bajo el paraguas corporativo.",
                impacts: { Omnicanalidad: 8, Popularidad: 6, Riesgo: 6, Margen: 6 },
              },
            ],
          },
          {
            id: "e5s2",
            title: "Experiencia Total Omnicanal.",
            description:
              "Pause & Play quiere consolidar su modelo omnicanal conectando completamente la experiencia f√≠sica y digital. La direcci√≥n estudia incorporar terminales de apuestas deportivas en los locales, integradas con las cuentas online:",
            options: [
              {
                id: "instalar-todos",
                label:
                  "Instalar terminales en todos los locales y comunicarlo como salto tecnol√≥gico de la marca.",
                impacts: { Omnicanalidad: 10, Sala: 15, Riesgo: 8, Margen: -10 },
              },
              {
                id: "piloto-centros",
                label:
                  "Probar el modelo en unos pocos centros estrat√©gicos y escalar gradualmente seg√∫n resultados.",
                impacts: { Omnicanalidad: 6, Sala: 8, Riesgo: 4, Margen: -4 },
              },
              {
                id: "priorizar-comunidades",
                label:
                  "Priorizar comunidades con mayor madurez digital y permisos favorables para optimizar recursos.",
                impacts: { Omnicanalidad: 8, Sala: 10, Riesgo: 3, Margen: -6 },
              },
            ],
          },
        ],
      },
      {
        type: "event",
        heading: "Evento exclusivo:",
        title: "Siguientes pasos",
        description:
          "Despu√©s de a√±os de evoluci√≥n, Pause & Play ha alcanzado la cima del sector como operador omnicanal con presencia nacional y licencia AADD. El √©xito es innegable‚Ä¶ pero tambi√©n lo es la responsabilidad de liderar el futuro del entretenimiento regulado. La direcci√≥n debe decidir cu√°l ser√° el rumbo de la compa√±√≠a en esta nueva era:",
        scenarios: [
          {
            id: "e5ev1",
            title: "",
            options: [
              {
                id: "expandir-fronteras",
                label:
                  "Expandir fronteras. Llevar el modelo Pause & Play a nuevos pa√≠ses, replicando la experiencia omnicanal a nivel internacional.",
                impacts: { Omnicanalidad: 20, Riesgo: 15, Margen: 10 },
                isKey: true,
              },
              {
                id: "innovar-experiencia",
                label:
                  "Innovar la experiencia. Apostar por nuevas tecnolog√≠as (IA, VR, streaming) para reinventar el entretenimiento f√≠sico y digital.",
                impacts: { Satisfacci√≥n: 15, Popularidad: 10, Margen: -10, Riesgo: 6, Omnicanalidad: 8 },
              },
              {
                id: "diversificar-negocio",
                label:
                  "Diversificar el negocio. Abrir nuevas l√≠neas de ocio bajo el sello Pause & Play.",
                impacts: { Margen: 10, Riesgo: 6, Omnicanalidad: 6, Popularidad: 6 },
              },
            ],
          },
        ],
      },
    ],
  },
];

// NOTA EXTRA (texto visible) ‚Äî se muestra si se elige la opci√≥n con triggersNoteId: 'rgiaj'
const EXTRA_NOTES: Record<string, string> = {
  rgiaj:
    "NOTA EXTRA: El cliente informa que su situaci√≥n es delicada y se inscribe en el RGIAJ.",
};

// ---------- Utilidades ----------

const valueList: ValueKey[] = [
  "Omnicanalidad",
  "Riesgo",
  "Margen",
  "Satisfacci√≥n",
  "Popularidad",
  "Online",
  "Sala",
];

function clamp(v: number, min = 0, max = 100) {
  return Math.max(min, Math.min(max, v));
}

function prettyDelta(n: number) {
  return (n > 0 ? "+" : "") + n;
}

// ---------- UI ----------

function StatBar({ name, value }: { name: string; value: number }) {
  return (
    <div className="w-full">
      <div className="flex items-center justify-between text-sm mb-1">
        <span className="font-medium">{name}</span>
        <span className="tabular-nums">{value}</span>
      </div>
      <div className="h-2.5 w-full bg-gray-200 rounded-full overflow-hidden">
        <div
          className="h-2.5 bg-black/80 rounded-full"
          style={{ width: `${value}%` }}
        />
      </div>
    </div>
  );
}

function Badge({ children }: { children: React.ReactNode }) {
  return (
    <span className="px-2 py-0.5 rounded-full border text-xs font-medium">
      {children}
    </span>
  );
}

function TimeJump({ label, onDone }: { label: string; onDone: () => void }) {
  return (
    <AnimatePresence>
      {label && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 z-[60] bg-white/90 backdrop-blur flex items-center justify-center"
        >
          <motion.div
            initial={{ scale: 0.8, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0.9, opacity: 0 }}
            transition={{ type: "spring", stiffness: 120, damping: 12 }}
            className="text-center"
          >
            <div className="text-5xl font-extrabold mb-3">üìÜ</div>
            <div className="text-3xl font-bold mb-6">{label}</div>
            <button
              onClick={onDone}
              className="px-5 py-2 rounded-2xl bg-black text-white hover:opacity-90"
            >
              Continuar
            </button>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}

export default function PausePlayRumboALaCima() {
  const [stageIndex, setStageIndex] = useState(0);
  const [values, setValues] = useState<Record<ValueKey, number>>({
    Omnicanalidad: 40,
    Riesgo: 40,
    Margen: 50,
    Satisfacci√≥n: 50,
    Popularidad: 40,
    Online: 30,
    Sala: 30,
  } as Record<ValueKey, number>);

  const [history, setHistory] = useState<
    { stageId: string; scenarioId: string; optionId: string }[]
  >([]);

  const [pendingTimeJump, setPendingTimeJump] = useState<string>("");
  const [noteIds, setNoteIds] = useState<string[]>([]);

  const current = STAGES[stageIndex];

  const allDone = useMemo(() => {
    // finished when we've interacted with all blocks in current stage?
    // We'll allow free navigation but show a "Siguiente etapa" button always.
    return false;
  }, [stageIndex]);

  function applyImpacts(impacts: Impacts) {
    setValues((prev) => {
      const next = { ...prev };
      for (const k of Object.keys(impacts) as ValueKey[]) {
        next[k] = clamp((prev[k] ?? 0) + impacts[k]);
      }
      return next;
    });
  }

  function onPickOption(scenario: Scenario, option: ChoiceOption) {
    applyImpacts(option.impacts);

    if (option.triggersNoteId) {
      setNoteIds((prev) => (prev.includes(option.triggersNoteId!) ? prev : [...prev, option.triggersNoteId!]));
    }

    setHistory((h) => [
      ...h,
      { stageId: current.id, scenarioId: scenario.id, optionId: option.id },
    ]);
  }

  function goNextStage() {
    if (stageIndex < STAGES.length - 1) {
      const nextIdx = stageIndex + 1;
      const nextStage = STAGES[nextIdx];
      if (nextStage.timeJump) setPendingTimeJump(nextStage.timeJump);
      setStageIndex(nextIdx);
    }
  }

  function goPrevStage() {
    if (stageIndex > 0) setStageIndex((i) => i - 1);
  }

  return (
    <div className="min-h-screen bg-white text-black p-4 md:p-8">
      <div className="max-w-6xl mx-auto grid gap-6 md:gap-8">
        {/* Header */}
        <div className="flex items-start justify-between gap-4">
          <div>
            <h1 className="text-2xl md:text-4xl font-extrabold tracking-tight">
              Pause & Play: Rumbo a la Cima
            </h1>
            <p className="text-sm md:text-base text-gray-600 mt-1">
              {current.icon} <span className="font-semibold">{current.title}</span>
            </p>
          </div>
          {/* Simple map-like nav */}
          <div className="hidden md:flex items-center gap-2">
            {STAGES.map((s, i) => (
              <button
                key={s.id}
                onClick={() => setStageIndex(i)}
                className={`px-3 py-1.5 rounded-full border text-sm ${
                  i === stageIndex ? "bg-black text-white" : "hover:bg-gray-100"
                }`}
                title={s.title}
              >
                {s.icon} {i}
              </button>
            ))}
          </div>
        </div>

        {/* Scoreboard */}
        <div className="grid md:grid-cols-2 gap-4 md:gap-6">
          <div className="p-4 md:p-5 rounded-2xl border shadow-sm">
            <h2 className="font-bold mb-3">Tablero de valores</h2>
            <div className="grid grid-cols-1 gap-3">
              {valueList.map((v) => (
                <StatBar key={v} name={v} value={values[v]} />
              ))}
            </div>
          </div>

          {/* Mini ‚Äúmapa‚Äù de etapas */}
          <div className="p-4 md:p-5 rounded-2xl border shadow-sm">
            <h2 className="font-bold mb-3">Mapa de etapas</h2>
            <div className="grid grid-cols-6 gap-2">
              {STAGES.map((s, i) => (
                <div
                  key={s.id}
                  className={`flex flex-col items-center justify-center p-2 rounded-xl border text-xs md:text-sm ${
                    i === stageIndex ? "bg-black text-white" : "bg-gray-50"
                  }`}
                >
                  <div className="text-lg">{s.icon}</div>
                  <div>{i}</div>
                </div>
              ))}
            </div>
            <div className="mt-3 flex gap-2">
              <button
                onClick={goPrevStage}
                disabled={stageIndex === 0}
                className="px-3 py-1.5 rounded-xl border hover:bg-gray-100 disabled:opacity-50"
              >
                ‚Üê Anterior
              </button>
              <button
                onClick={goNextStage}
                disabled={stageIndex === STAGES.length - 1}
                className="px-3 py-1.5 rounded-xl border hover:bg-gray-100 disabled:opacity-50"
              >
                Siguiente ‚Üí
              </button>
            </div>
          </div>
        </div>

        {/* Content: Textos EXACTOS + opciones */}
        <div className="p-4 md:p-6 rounded-2xl border shadow-sm">
          {/* Headings */}
          {current.blocks.map((block, idx) => (
            <div key={idx} className="mb-6 md:mb-8">
              {/* Block heading */}
              <h3 className="text-lg md:text-xl font-semibold mb-2">
                {block.type === "event" ? (
                  <span>
                    {block.heading} <span className="italic">{(block as any).title}</span>
                  </span>
                ) : (
                  block.heading
                )}
              </h3>

              {/* Optional description (event) */}
              {block.type === "event" && (block as any).description && (
                <p className="text-sm md:text-base text-gray-700 mb-3">
                  {(block as any).description}
                </p>
              )}

              {block.type === "scenarios" && (
                <div className="grid gap-5">
                  {block.scenarios.map((sc) => (
                    <div key={sc.id} className="rounded-2xl border p-4">
                      <div className="flex items-start justify-between gap-3">
                        <div>
                          <h4 className="font-semibold">{sc.title}</h4>
                          {sc.description && (
                            <p className="text-sm text-gray-700 mt-1">{sc.description}</p>
                          )}
                        </div>
                        <Badge>Escenario</Badge>
                      </div>
                      <div className="mt-3 grid gap-2">
                        {sc.options.map((op) => (
                          <motion.button
                            whileTap={{ scale: 0.98 }}
                            key={op.id}
                            onClick={() => onPickOption(sc, op)}
                            className={`text-left w-full border rounded-xl p-3 hover:bg-gray-50 ${
                              op.isKey ? "border-black" : "border-gray-200"
                            }`}
                            title={op.isKey ? "Decisi√≥n clave" : "Decisi√≥n"}
                          >
                            <div className="flex items-center justify-between gap-2">
                              <span>{op.label}</span>
                              {op.isKey && <Badge>Clave</Badge>}
                            </div>
                            {/* Impacts preview */}
                            <div className="mt-2 text-xs text-gray-600 flex flex-wrap gap-x-2 gap-y-1">
                              {Object.entries(op.impacts).map(([k, v]) => (
                                <span key={k} className="whitespace-nowrap">
                                  {k}: {prettyDelta(v as number)}
                                </span>
                              ))}
                            </div>
                          </motion.button>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {block.type === "event" && (
                <div className="grid gap-5">
                  {block.scenarios.map((sc) => (
                    <div key={sc.id} className="rounded-2xl border p-4">
                      <div className="flex items-start justify-between gap-3">
                        <div>
                          {/* Los eventos pueden no tener t√≠tulo interno */}
                          {sc.title && <h4 className="font-semibold">{sc.title}</h4>}
                        </div>
                        <Badge>Evento</Badge>
                      </div>
                      <div className="mt-3 grid gap-2">
                        {sc.options.map((op) => (
                          <motion.button
                            whileTap={{ scale: 0.98 }}
                            key={op.id}
                            onClick={() => onPickOption(sc, op)}
                            className={`text-left w-full border rounded-xl p-3 hover:bg-gray-50 ${
                              op.isKey ? "border-black" : "border-gray-200"
                            }`}
                          >
                            <div className="flex items-center justify-between gap-2">
                              <span>{op.label}</span>
                              {op.isKey && <Badge>Clave</Badge>}
                            </div>
                            <div className="mt-2 text-xs text-gray-600 flex flex-wrap gap-x-2 gap-y-1">
                              {Object.entries(op.impacts).map(([k, v]) => (
                                <span key={k} className="whitespace-nowrap">
                                  {k}: {prettyDelta(v as number)}
                                </span>
                              ))}
                            </div>
                          </motion.button>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}

          {/* NOTAS EXTRA visibles cuando corresponda */}
          {noteIds.map((nid) => (
            <div key={nid} className="mt-4 p-4 rounded-xl bg-yellow-50 border text-sm">
              {EXTRA_NOTES[nid]}
            </div>
          ))}

          {/* Navegaci√≥n inferior */}
          <div className="mt-6 flex items-center justify-between">
            <div className="text-xs text-gray-500">
              Etapa {stageIndex} de {STAGES.length - 1}
            </div>
            <div className="flex gap-2">
              <button
                onClick={goPrevStage}
                disabled={stageIndex === 0}
                className="px-3 py-1.5 rounded-xl border hover:bg-gray-100 disabled:opacity-50"
              >
                ‚Üê Anterior
              </button>
              <button
                onClick={goNextStage}
                disabled={stageIndex === STAGES.length - 1}
                className="px-3 py-1.5 rounded-xl border hover:bg-gray-100 disabled:opacity-50"
              >
                Siguiente ‚Üí
              </button>
            </div>
          </div>
        </div>

        {/* Hist√≥rico (opcional) */}
        <div className="p-4 md:p-5 rounded-2xl border shadow-sm">
          <h2 className="font-bold mb-2">Hist√≥rico de decisiones</h2>
          {history.length === 0 ? (
            <p className="text-sm text-gray-600">A√∫n no has tomado decisiones.</p>
          ) : (
            <ul className="text-sm grid gap-1">
              {history.map((h, i) => (
                <li key={i} className="text-gray-700">
                  {i + 1}. <span className="font-medium">{h.stageId}</span> ‚Üí {h.scenarioId} ‚Üí {h.optionId}
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>

      {/* Calendario / salto temporal */}
      <TimeJump label={pendingTimeJump} onDone={() => setPendingTimeJump("")} />
    </div>
  );
}

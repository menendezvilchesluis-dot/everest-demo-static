<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pause & Play — Everest Omnicanal (Juego)</title>
    <link rel="icon" href="data:,">

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root { color-scheme: dark; }
      body { background: linear-gradient(to bottom, #111827, #0b0f19, #000); color: #fff; }
      .card { border: 1px solid #374151; background: rgba(31,41,55,0.7); border-radius: 1rem; }
      .progress { height: 8px; border-radius: 9999px; background: #374151; overflow: hidden }
      .progress > div { height: 100%; background: #ef4444; transition: width .25s ease; }
      .btn { border-radius: .75rem; font-weight: 600; padding: .6rem 1rem; }
      .btn-primary { background: #dc2626; } .btn-primary:hover { background: #b91c1c; }
      .btn-secondary { background: #374151; } .btn-outline { border: 1px solid #4b5563; }
      .btn-outline:hover { border-color: #ef4444; }
      .btn:disabled { opacity:.5; cursor:not-allowed; }
      .opt-picked { border-color:#f87171 !important; background:rgba(239,68,68,.08) !important; }
      .badge { font-size:.7rem; padding:.15rem .45rem; border:1px solid #4b5563; border-radius:.45rem; background:#111827; }
      .logbox { max-height: 320px; overflow: auto; }
    </style>

    <!-- React + ReactDOM -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Framer Motion (fallback si no carga) -->
    <script src="https://cdn.jsdelivr.net/npm/framer-motion/dist/framer-motion.umd.js"></script>

    <!-- Babel (JSX en navegador) -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div class="p-6 md:p-10"><div id="root"></div></div>

    <script type="text/babel" data-presets="react">
      // ====== Fallback por si Framer Motion no carga ======
      const FM = window['framer-motion'] || {};
      const motion = FM.motion || new Proxy({}, { get: () => (props) => React.createElement('div', props) });
      const AnimatePresence = FM.AnimatePresence || (({children}) => children);

      const { useState, useMemo, useEffect } = React;
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      const rnd = (n) => Math.round(n);

      const fx = {
        play: (name, vol=0.5, muted=false) => { if (muted) return; const a = new Audio('sounds/' + name + '.mp3'); a.volume = vol; a.play().catch(() => {}); }
      };

      // =======================
      // CONFIG MODO DIFÍCIL
      // =======================
      const DIFFICULTY = {
        posScale: 0.8,
        negScale: 1.1,
        softCaps: {
          ltv:           [78, 86, 92, 96, 100],
          satisfaction:  [85, 90, 94, 97, 100],
          omni:          [82, 88, 93, 97, 100],
          online:        [88, 92, 96, 98, 100],
          offline:       [88, 92, 96, 98, 100],
          risk:          [100,100,100,100,100],
          popularity:    [90, 94, 97, 99, 100],
          margin:        [80, 88, 92, 96, 100],
        },
        fatiguePenalty: { omni: 4, sat: 3, ltv: 2, risk: 4 },
        diminishingStart: 80
      };

      const softCapFor = (metric, levelIndex) => {
        const caps = DIFFICULTY.softCaps[metric] || [100,100,100,100,100];
        return caps[Math.min(levelIndex, caps.length-1)];
      };

      function applyPosWithCaps(current, delta, levelCap) {
        if (delta <= 0) return delta;
        let d = delta * DIFFICULTY.posScale;
        const start = DIFFICULTY.diminishingStart;
        if (current >= start) {
          const factor = clamp(1 - ((current - start) / (100 - start)), 0.15, 1);
          d *= factor;
        }
        if (current >= levelCap) {
          d *= 0.2;
        } else if (current + d > levelCap) {
          const extra = (current + d) - levelCap;
          d -= extra * 0.5;
        }
        return d;
      }

      function applyNegWithDifficulty(delta) {
        if (delta >= 0) return delta;
        return delta * DIFFICULTY.negScale;
      }

      function biasOfImpact(impact) {
        const on = impact.online_activity ?? 0;
        const off = impact.offline_activity ?? 0;
        if (on - off > 6) return 'online';
        if (off - on > 6) return 'offline';
        return 'balanced';
      }

      // =======================
      // CONTENIDO: CARTAS
      // =======================
      const LEVELS = [
        { key:'captacion', title:'Campamento Base — Captación', scenarios: [
          // ====== BASE 1: Elegir tipo de captación ======
          {
            id:'CAPT_1',
            title:'Elige tu estrategia de Captación',
            text:'Selecciona el canal principal para adquirir clientes:',
            options:[
              {
                text:'Colaboradores de sala (bajo coste, poco margen, poco riesgo, sube omnicanalidad)',
                impact:{
                  LTV:+3, satisfaction:+2, risk:-4,
                  omnichannel_index:+12, online_activity:+4, offline_activity:+10,
                  popularity:+2, margin:-2
                }
              },
              {
                text:'RRSS y Buscadores (coste medio, riesgo medio, poca omnicanalidad)',
                impact:{
                  LTV:+4, satisfaction:+1, risk:+4,
                  omnichannel_index:-2, online_activity:+10, offline_activity:+1,
                  popularity:+6, margin:-4
                }
              },
              {
                text:'TV y Streamers (coste alto, riesgo alto, omnicanalidad media)',
                impact:{
                  LTV:+6, satisfaction:+1, risk:+8,
                  omnichannel_index:+4, online_activity:+8, offline_activity:+2,
                  popularity:+12, margin:-8
                }
              },
            ]
          },
          // ====== BASE 2: Promoción en web + bono 200% + Free Spins ======
          {
            id:'CAPT_2',
            title:'Promoción: Web + Bono 200% + Free Spins',
            text:'Define el umbral de verificación y la segmentación del incentivo:',
            options:[
              {
                text:'Lanzarla para todo el mundo sin verificar (más margen, más popularidad, más riesgo, omnicanalidad media)',
                impact:{
                  LTV:+3, satisfaction:+1, risk:+10,
                  omnichannel_index:+2, online_activity:+8, offline_activity:+0,
                  popularity:+8, margin:+4
                }
              },
              {
                text:'Solo clientes verificados (menos margen, menos riesgo, omnicanalidad media)',
                impact:{
                  LTV:+1, satisfaction:+2, risk:-8,
                  omnichannel_index:+2, online_activity:+2, offline_activity:+0,
                  popularity:-2, margin:-2
                }
              },
              {
                text:'Solo verificados + segmentar 50FS extra para registros (equilibrio, menos popularidad)',
                impact:{
                  LTV:+2, satisfaction:+3, risk:-6,
                  omnichannel_index:+6, online_activity:+4, offline_activity:+1,
                  popularity:-1, margin:-1
                }
              },
            ]
          },
        ]},
        { key:'activacion', title:'Campamento 1 — Activación', scenarios: [
          {
            id:'A1',
            title:'Cliente de sala descubre online',
            text:'Un habitual de sala descarga la app; baja su ritmo presencial.',
            options:[
              { text:'Enviar bono personalizado',            impact:{ LTV:+5,  satisfaction:+2,  risk:+6,  omnichannel_index:-6, online_activity:+14, offline_activity:-12, popularity:+2, margin:-3 } },
              { text:'Combo sala + online (equilibrado)',    impact:{ LTV:+7,  satisfaction:+7,  risk:+1,  omnichannel_index:+16, online_activity:+8,  offline_activity:+8, popularity:+4, margin:-2 } },
              { text:'No intervenir',                        impact:{ LTV:-4, satisfaction:-6, risk:+0,  omnichannel_index:-8,  online_activity:+0,  offline_activity:-10 } },
            ]
          },
          {
            id:'A2',
            title:'Tutorial en sala para jugar online',
            text:'Sesión guiada en local + consumición.',
            options:[
              { text:'Hacerlo fin de semana (alta afluencia)',  impact:{ LTV:+6, satisfaction:+8, risk:+2,  omnichannel_index:+12, online_activity:+8, offline_activity:+6, popularity:+4, margin:-2 } },
              { text:'Hacerlo laborables (baja fricción)',       impact:{ LTV:+4, satisfaction:+5, risk:+1,  omnichannel_index:+8,  online_activity:+6, offline_activity:+4, popularity:+2, margin:-1 } },
            ]
          },
        ]},
        { key:'retencion', title:'Campamento 2 — Retención', scenarios: [
          {
            id:'R1',
            title:'Cross-Promo Doble Pista',
            text:'Juega online → copa en sala; juega en sala → spins online.',
            options:[
              { text:'Segmentada por valor',  impact:{ LTV:+9,  satisfaction:+7, risk:+1, omnichannel_index:+18, online_activity:+10, offline_activity:+10, popularity:+5, margin:-2 } },
              { text:'Para todos',            impact:{ LTV:+3,  satisfaction:+5, risk:+6, omnichannel_index:+6,  online_activity:+8,  offline_activity:+6,  popularity:+3, margin:-4 } },
            ]
          },
          {
            id:'R2',
            title:'Evento F1 en sala (invitación desde app)',
            text:'Viewing party con ventajas para jugadores online.',
            options:[
              { text:'VIPs online',      impact:{ LTV:+8, satisfaction:+8, risk:+1, omnichannel_index:+12, online_activity:+4,  offline_activity:+14, popularity:+6, margin:-3 } },
              { text:'Activos 30 días',  impact:{ LTV:+6, satisfaction:+6, risk:+3, omnichannel_index:+8,  online_activity:+5,  offline_activity:+10, popularity:+4, margin:-2 } },
            ]
          },
        ]},
        { key:'riesgo', title:'Campamento 3 — Riesgo', scenarios: [
          {
            id:'S1',
            title:'Jugador intensivo omnicanal',
            text:'Señales de juego intenso. ¿Qué haces?',
            options:[
              { text:'Activar límites y enfriar',    impact:{ LTV:-6, satisfaction:+4,  risk:-16, omnichannel_index:+0,  online_activity:-8, offline_activity:-6, popularity:-2, margin:-1 } },
              { text:'No intervenir',                 impact:{ LTV:+2, satisfaction:-12, risk:+20,  omnichannel_index:-8, online_activity:+10, offline_activity:+8, popularity:-6, margin:+1 } },
            ]
          },
          {
            id:'S2',
            title:'Auto-exclusión voluntaria',
            text:'Cliente solicita auto-exclusión.',
            options:[
              { text:'Proceder y ofrecer ayuda',         impact:{ LTV:-12, satisfaction:+10, risk:-24, omnichannel_index:+0,  online_activity:-15, offline_activity:-10, popularity:+2, margin:-1 } },
              { text:'Intentar retener (NO recomendado)',impact:{ LTV:+4,   satisfaction:-14, risk:+30, omnichannel_index:-10, online_activity:+10,  offline_activity:+6, popularity:-10, margin:+1 } },
            ]
          },
        ]},
        { key:'fidelizacion', title:'Campamento 4 — Fidelización', scenarios: [
          {
            id:'F1',
            title:'Club VIP Omnicanal Everest',
            text:'Puntos válidos en sala y online.',
            options:[
              { text:'Lanzamiento top 20%',  impact:{ LTV:+10, satisfaction:+12, risk:+1, omnichannel_index:+20, online_activity:+10, offline_activity:+10, popularity:+8, margin:-3 } },
              { text:'Lanzamiento general',  impact:{ LTV:+6,  satisfaction:+9,  risk:+3, omnichannel_index:+14, online_activity:+8,  offline_activity:+8,  popularity:+6, margin:-2 } },
            ]
          },
          {
            id:'F2',
            title:'Viewing party Madrid–Barça',
            text:'Acceso gratuito a clientes online con cierto nivel.',
            options:[
              { text:'Sólo Plata+',  impact:{ LTV:+7, satisfaction:+9, risk:+1, omnichannel_index:+12, online_activity:+4,  offline_activity:+14, popularity:+6, margin:-3 } },
              { text:'Abierta',       impact:{ LTV:+5, satisfaction:+7, risk:+2, omnichannel_index:+8,  online_activity:+4,  offline_activity:+10, popularity:+4, margin:-2 } },
            ]
          },
        ]},
      ];

      // ========= EVENTOS CONTEXTUALES (España, sin TV) =========
      // Todos impactan Margen.
      const EVENT_TEMPLATES = {
        // Reemplazo por NUEVO REDISEÑO APP (con seguimiento si hay encuesta)
        app_redesign:  { title:'📱 Nuevo rediseño de la app',
          text:'Se prepara un rediseño que mejora rendimiento y previene errores.',
          options:[
            { text:'Aplicarla ya (downtime breve)', impact:{
                satisfaction:+5, risk:-2, omnichannel_index:+6, online_activity:-8, margin:-3
              } },
            { text:'No aplicarla y lanzar encuesta', impact:{
                popularity:+1, margin:-1,
                __followup: {
                  title:'🧪 Resultados de la encuesta',
                  text:'Los clientes han opinado sobre el rediseño.',
                  options:[
                    { text:'Rediseño parcial (iterativo)', impact:{ satisfaction:+3, omnichannel_index:+3, margin:-1 } },
                    { text:'Aplazar y reforzar estabilidad', impact:{ satisfaction:-2, risk:+2, margin:+1 } },
                  ]
                }
              } },
            { text:'Lanzarla solo en iOS', impact:{
                satisfaction:+3, risk:-1, omnichannel_index:+3, online_activity:-3, margin:-2
              } },
          ]},

        social_viral:{ title:'🎉 Mini-viral en TikTok',
          text:'Un clip de clientes se hace viral.',
          options:[
            { text:'Challenge omnicanal (UGC)', impact:{ popularity:+6, omnichannel_index:+6, satisfaction:+2, margin:-2 } },
            { text:'Dejar que fluya (cero coste)', impact:{ popularity:+4, margin:+1 } },
          ]},
        complaints:  { title:'😕 Quejas en redes',
          text:'Hilo con críticas al servicio.',
          options:[
            { text:'Plan de mejora y respuesta', impact:{ satisfaction:+4, popularity:+1, margin:-2 } },
            { text:'Ignorar (riesgoso)',         impact:{ satisfaction:-5, popularity:-3, margin:+1 } },
          ]},
        fraud_alert: { title:'🛡️ Detección de patrón de riesgo',
          text:'Actividad detectada que requiere intervención.',
          options:[
            { text:'Aplicar límites y cool-off', impact:{ risk:-12, satisfaction:+2, LTV:-3, margin:-1 } },
            { text:'Mensaje de apoyo',          impact:{ risk:-6,  satisfaction:+4, margin:-1 } },
          ]},
        cost_spike:  { title:'💸 Sobrecoste en pujas de afiliados',
          text:'El mix de captación via afiliados ha subido de precio.',
          options:[
            { text:'Reoptimizar mix', impact:{ margin:+2, popularity:-1, omnichannel_index:+2 } },
            { text:'Mantener inversión', impact:{ margin:-4, popularity:+2 } },
          ]},
        imbalance:   { title:'🔁 Fatiga por sesgo de canal',
          text:'Estás empujando demasiado un solo canal.',
          options:[
            { text:'Bundle sala + online', impact:{ omnichannel_index:+10, satisfaction:+4, online_activity:+4, offline_activity:+4, margin:-2 } },
            { text:'Seguir así', impact:{ satisfaction:-4, risk:+4, margin:+1 } },
          ]},
        low_omni:    { title:'🧩 Fricción entre canales',
          text:'Clientes reportan experiencia dispareja.',
          options:[
            { text:'Mejorar onboarding cruzado', impact:{ omnichannel_index:+8, satisfaction:+3, margin:-2 } },
            { text:'Postergar', impact:{ satisfaction:-3, margin:+1 } },
          ]},
      };

      // ========= EVENTOS EXCLUSIVOS POR CAMPAMENTO =========
      const EXCLUSIVE_EVENTS = {
        0: { // Captación
          title:'📣 Colaboración con streamer',
          text:'Un creador propone una colaboración regulada (sin emisión TV).',
          options:[
            { text:'Patrocinio con streamer (branding)', impact:{ popularity:+8, risk:+2, margin:-5, omnichannel_index:+4 } },
            { text:'Afiliación a CPA (rendimiento)',     impact:{ popularity:+5, risk:+1, margin:-2, omnichannel_index:+4 } },
            { text:'Ignorar la propuesta',                impact:{ popularity:-1, margin:+0 } },
          ]
        },
        1: { // Activación
          title:'🛠️ Incidencia en onboarding de la app',
          text:'Un bug afecta el registro en ciertos móviles.',
          options:[
            { text:'Compensar con bono y fix urgente', impact:{ satisfaction:+6, risk:-1, popularity:+2, margin:-4, omnichannel_index:+4 } },
            { text:'Comunicar y arreglar sin bono',    impact:{ satisfaction:+2, margin:-1 } },
            { text:'Ignorar (mala práctica)',          impact:{ satisfaction:-6, popularity:-3, risk:+4, margin:+1 } },
          ]
        },
        2: { // Retención
          title:'🎰 Nuevo juego estrella',
          text:'Título con alto interés de clientes.',
          options:[
            { text:'Lanzar en sala + online', impact:{ popularity:+6, omnichannel_index:+10, margin:-3 } },
            { text:'Priorizar online',        impact:{ popularity:+4, online_activity:+8,  omnichannel_index:-3, margin:-1 } },
            { text:'Priorizar sala',          impact:{ popularity:+4, offline_activity:+8, omnichannel_index:-3, margin:-1 } },
          ]
        },
        3: { // Riesgo
          title:'⚖️ Revisión regulatoria',
          text:'La autoridad solicita evidencias de juego responsable.',
          options:[
            { text:'Refuerzo de políticas y límites', impact:{ risk:-12, popularity:+1, margin:-3 } },
            { text:'Formación intensiva equipo',      impact:{ risk:-6,  satisfaction:+2, margin:-2 } },
            { text:'Minimizar cambios',               impact:{ risk:+6,  popularity:-2, margin:+0 } },
          ]
        },
        4: { // Fidelización
          title:'🏆 Evento VIP omnicanal',
          text:'Fiesta exclusiva con perks en app y sala.',
          options:[
            { text:'Invitar Top 10% valor', impact:{ satisfaction:+8, popularity:+6, margin:-4, omnichannel_index:+6 } },
            { text:'General con cupo',      impact:{ satisfaction:+5, popularity:+4, margin:-2 } },
            { text:'Solo perks digitales',  impact:{ satisfaction:+3, popularity:+3, margin:-1, online_activity:+6 } },
          ]
        },
      };

      // ========= Selector de eventos contextuales por “mes” =========
      function pickContextEvents(level, metrics, lastBias, biasStreak){
        const evs = [];
        const { popularity, risk, margin, omni, satisfaction } = metrics;
        // Rediseño de app es relevante si la satisfacción no es perfecta o si Omni es medio-bajo
        if (satisfaction < 90 || omni < 80) evs.push('app_redesign');
        if (popularity > 60) evs.push('social_viral');
        if (risk > 60) evs.push('fraud_alert');
        if (margin < 40) evs.push('cost_spike');
        if (omni < 45) evs.push('low_omni');
        if (biasStreak>=2 && (lastBias==='online' || lastBias==='offline')) evs.push('imbalance');
        if (satisfaction < 50) evs.push('complaints');
        if (evs.length===0) evs.push('app_redesign'); // fallback
        const n = Math.min(2, Math.max(1, Math.round(Math.random()*evs.length)));
        return evs.slice(0, n).map(k=>EVENT_TEMPLATES[k]);
      }

      // =======================
      // UI
      // =======================
      const ProgressBar = ({ value=0, color='#ef4444' }) => {
        const v = clamp(Math.round(value), 0, 100);
        return <div className="progress w-full"><div style={{width: v+'%', background: color}}></div></div>;
      };

      function HUD({ ltv, omni, satisfaction, risk, online, offline, popularity, margin }) {
        const items = [
          {label:'💰 LTV',val:rnd(ltv),color:'#22c55e'},
          {label:'🔄 Omnicanalidad',val:rnd(omni),isPct:true,color:'#60a5fa'},
          {label:'❤️ Satisfacción',val:rnd(satisfaction),isPct:true,color:'#f97316'},
          {label:'⚠️ Riesgo',val:rnd(risk),isPct:true,color:'#ef4444'},
          {label:'📣 Popularidad',val:rnd(popularity),isPct:true,color:'#eab308'},
          {label:'📈 Margen',val:rnd(margin),isPct:true,color:'#10b981'},
          {label:'🏪 Sala',val:rnd(offline),isPct:true,color:'#a78bfa'},
          {label:'💻 Online',val:rnd(online),isPct:true,color:'#34d399'}
        ];
        return (
          <div className="mt-6 grid sm:grid-cols-2 md:grid-cols-4 xl:grid-cols-8 gap-4">
            {items.map((m) => (
              <div key={m.label} className="card">
                <div className="p-4">
                  <p className="text-xs text-gray-300/80">{m.label}</p>
                  <div className="flex items-center gap-3 mt-2">
                    <ProgressBar value={m.val} color={m.color} />
                    <span className="text-sm text-gray-200 w-12 text-right">
                      {m.isPct?`${clamp(m.val,0,100)}%`:clamp(m.val,0,100)}
                    </span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        );
      }

      function SuccessPanel({ success }){
        const tag = success<40 ? 'fracaso' : success<60 ? 'inestable' : success<75 ? 'correcto' : success<90 ? 'muy bueno' : 'excelencia';
        const color = success>=90? '#16a34a' : success>=75? '#22c55e' : success>=60? '#f59e0b' : success>=40? '#fbbf24' : '#ef4444';
        return (
          <div className="card">
            <div className="p-5">
              <div className="flex items-baseline justify-between">
                <div>
                  <div className="text-4xl font-bold">{success}</div>
                  <div className="text-xs text-gray-300/80">Éxito del Casino (0–100)</div>
                </div>
                <span className="badge" style={{borderColor:color,color}}>{tag}</span>
              </div>
              <div className="mt-3"><ProgressBar value={success} color={color} /></div>
            </div>
          </div>
        );
      }

      function Board({ levelIndex, onStartScenario, metrics, success, log }) {
        const { ltv, omni, satisfaction, risk, online, offline, popularity, margin } = metrics;
        return (
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 card">
              <div className="p-8">
                <h2 className="text-2xl md:text-3xl font-bold mb-6 flex items-center gap-2">🏔️ Tablero del Everest</h2>
                <div className="grid md:grid-cols-6 gap-3">
                  {Array.from({length:5}).map((_, i) => (
                    <div key={i} className="flex flex-col items-center">
                      <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-white shadow-lg ${i <= levelIndex ? 'bg-red-600' : 'bg-gray-600'}`}>{i+1}</div>
                      <p className="text-xs text-gray-300 mt-2">Camp {i}</p>
                    </div>
                  ))}
                </div>
                <HUD ltv={ltv} omni={omni} satisfaction={satisfaction} risk={risk} online={online} offline={offline} popularity={popularity} margin={margin} />
                <div className="mt-6 flex flex-wrap gap-3">
                  <button className="btn btn-primary" onClick={onStartScenario}>Abrir escenario</button>
                </div>

                <div className="card mt-6">
                  <div className="p-4">
                    <h3 className="font-semibold mb-2">Eventos (entre campamentos)</h3>
                    <ul className="text-sm logbox" id="log">
                      {log.map((row, idx) => (
                        <li key={idx} className="py-1"><span className="text-gray-400">Mes {row.month}: </span><span dangerouslySetInnerHTML={{__html: row.text}}></span></li>
                      ))}
                    </ul>
                  </div>
                </div>

              </div>
            </div>
            <div>
              <SuccessPanel success={success} />
            </div>
          </div>
        );
      }

      function ScenarioCard({ levelTitle, scenario, onChoose, selectedIndex }) {
        return (
          <div className="card">
            <div className="p-6 space-y-4">
              <p className="text-sm text-gray-300/80 uppercase tracking-wider">{levelTitle}</p>
              <h3 className="text-2xl md:text-3xl font-semibold text-red-400">{scenario.title}</h3>
              {scenario.text && <p className="text-gray-200/90">{scenario.text}</p>}
              <div className="grid md:grid-cols-3 gap-3">
                {scenario.options.map((opt, i) => {
                  const picked = selectedIndex === i;
                  return (
                    <button
                      key={i}
                      className={`btn btn-outline text-left ${picked ? 'opt-picked' : ''}`}
                      disabled={selectedIndex !== null && !picked}
                      onClick={() => onChoose(opt.impact, i)}
                    >
                      {opt.text} {picked && '✓'}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }

      function EventModal({ event, onChoose, onClose }) {
        return (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
            <div className="w-full max-w-xl">
              <div className="card" style={{borderColor:'#f59e0b'}}>
                <div className="p-6">
                  <h3 className="text-xl md:text-2xl font-bold text-yellow-400 flex items-center gap-2">{event.title}</h3>
                  <p className="text-gray-200 mt-2">{event.text}</p>
                  <div className="grid md:grid-cols-1 gap-3 mt-4">
                    {event.options.map((opt, i) => (
                      <button key={i} className="btn btn-secondary text-left" style={{background:'#f59e0b',color:'#000'}} onClick={() => onChoose(opt.impact)}>
                        {opt.text}
                      </button>
                    ))}
                  </div>
                  <div className="mt-3">
                    <button className="btn btn-outline" onClick={onClose}>Cerrar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      const FinalScreen = ({ score, stats, onRestart }) => (
        <div className="card">
          <div className="text-center space-y-4 py-12 px-6">
            <div className="text-5xl">🏆</div>
            <h2 className="text-3xl md:text-4xl font-extrabold text-red-400">¡Has alcanzado la Cima!</h2>
            <p className="text-gray-200 text-lg">Puntuación final: <span className="font-bold">{score}</span></p>
            <div className="grid md:grid-cols-3 gap-3 text-sm text-gray-200 max-w-3xl mx-auto">
              <div className="bg-white/5 p-3 rounded-xl">LTV: <b>{rnd(stats.ltv)}</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Omnicanalidad: <b>{rnd(stats.omni)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Satisfacción: <b>{rnd(stats.satisfaction)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Riesgo: <b>{rnd(stats.risk)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Sala: <b>{rnd(stats.offline)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Online: <b>{rnd(stats.online)}%</b></div>
            </div>
            <div className="flex justify-center gap-4 mt-4"><button className="btn btn-secondary" onClick={onRestart}>🔁 Reiniciar</button></div>
          </div>
        </div>
      );

      // =======================
      // APP
      // =======================
      function App() {
        const [screen, setScreen] = useState('lobby');
        const [levelIndex, setLevelIndex] = useState(0);
        const [scenarioIndex, setScenarioIndex] = useState(0);
        const [muted, setMuted] = useState(false);

        // Estado inicial
        const [ltv, setLtv] = useState(55);
        const [omni, setOmni] = useState(35);
        const [satisfaction, setSatisfaction] = useState(72);
        const [risk, setRisk] = useState(20);
        const [online, setOnline] = useState(45);
        const [offline, setOffline] = useState(55);
        const [popularity, setPopularity] = useState(60);
        const [margin, setMargin] = useState(55);

        const [pendingAdvance, setPendingAdvance] = useState(false);
        const [event, setEvent] = useState(null);
        const [eventQueue, setEventQueue] = useState([]);
        const [showDebug, setShowDebug] = useState(false);

        // Meses & log
        const [month, setMonth] = useState(1);
        const [log, setLog] = useState([]);

        // Exclusividad por escenario
        const [selectedIndex, setSelectedIndex] = useState(null);

        // Sesgo y fatiga
        const [lastBias, setLastBias] = useState('balanced');
        const [biasStreak, setBiasStreak] = useState(0);

        // ==== Persistencia local ====
        useEffect(() => {
          try{
            const raw = localStorage.getItem('everest_react_state_v2');
            if(raw){
              const s = JSON.parse(raw);
              setScreen(s.screen ?? 'lobby');
              setLevelIndex(s.levelIndex ?? 0);
              setScenarioIndex(s.scenarioIndex ?? 0);
              setMuted(!!s.muted);
              setLtv(s.ltv ?? 55); setOmni(s.omni ?? 35); setSatisfaction(s.satisfaction ?? 72);
              setRisk(s.risk ?? 20); setOnline(s.online ?? 45); setOffline(s.offline ?? 55);
              setPopularity(s.popularity ?? 60); setMargin(s.margin ?? 55);
              setLastBias(s.lastBias ?? 'balanced'); setBiasStreak(s.biasStreak ?? 0);
              setMonth(s.month ?? 1); setLog(s.log ?? []);
            }
          }catch(e){}
        }, []);

        useEffect(() => {
          const data = { screen, levelIndex, scenarioIndex, muted, ltv, omni, satisfaction, risk, online, offline, popularity, margin, lastBias, biasStreak, month, log };
          try{ localStorage.setItem('everest_react_state_v2', JSON.stringify(data)); }catch(e){}
        }, [screen, levelIndex, scenarioIndex, muted, ltv, omni, satisfaction, risk, online, offline, popularity, margin, lastBias, biasStreak, month, log]);

        useEffect(() => {
          const onKey = (e) => { if ((e.key || '').toLowerCase() === 'd') setShowDebug(s => !s); };
          window.addEventListener('keydown', onKey);
          return () => window.removeEventListener('keydown', onKey);
        }, []);

        const caps = {
          ltv:          softCapFor('ltv', levelIndex),
          satisfaction: softCapFor('satisfaction', levelIndex),
          omni:         softCapFor('omni', levelIndex),
          online:       softCapFor('online', levelIndex),
          offline:      softCapFor('offline', levelIndex),
          popularity:   softCapFor('popularity', levelIndex),
          margin:       softCapFor('margin', levelIndex),
        };

        // Motor con dificultad
        const applyImpact = (impact) => {
          let ltv1   = ltv;
          let sat1   = satisfaction;
          let risk1  = risk;
          let on1    = online;
          let off1   = offline;
          let omni1  = omni;
          let pop1   = popularity;
          let mar1   = margin;

          let d = {
            LTV: (impact.LTV ?? 0),
            SAT: (impact.satisfaction ?? 0),
            RISK:(impact.risk ?? 0),
            ON:  (impact.online_activity ?? 0),
            OFF: (impact.offline_activity ?? 0),
            OMNI:(impact.omnichannel_index ?? 0),
            POP: (impact.popularity ?? 0),
            MAR: (impact.margin ?? 0),
          };

          d.LTV  = d.LTV>=0 ? applyPosWithCaps(ltv1,  d.LTV,  caps.ltv)          : applyNegWithDifficulty(d.LTV);
          d.SAT  = d.SAT>=0 ? applyPosWithCaps(sat1,  d.SAT,  caps.satisfaction) : applyNegWithDifficulty(d.SAT);
          d.ON   = d.ON>=0  ? applyPosWithCaps(on1,   d.ON,   caps.online)       : applyNegWithDifficulty(d.ON);
          d.OFF  = d.OFF>=0 ? applyPosWithCaps(off1,  d.OFF,  caps.offline)      : applyNegWithDifficulty(d.OFF);
          d.OMNI = d.OMNI>=0? applyPosWithCaps(omni1, d.OMNI, caps.omni)         : applyNegWithDifficulty(d.OMNI);
          d.POP  = d.POP>=0 ? applyPosWithCaps(pop1,  d.POP,  caps.popularity)   : applyNegWithDifficulty(d.POP);
          d.MAR  = d.MAR>=0 ? applyPosWithCaps(mar1,  d.MAR,  caps.margin)       : applyNegWithDifficulty(d.MAR);
          d.RISK = d.RISK>=0? d.RISK * 1.0 : d.RISK * 1.1;

          ltv1  = ltv1  + d.LTV;
          sat1  = sat1  + d.SAT;
          risk1 = risk1 + d.RISK;
          on1   = on1   + d.ON;
          off1  = off1  + d.OFF;
          pop1  = pop1  + d.POP;
          mar1  = mar1  + d.MAR;

          on1  = clamp(on1,  0, 100); off1 = clamp(off1, 0, 100);
          const gap = Math.abs(on1 - off1);
          const balanceComponent = 18 - gap * 0.20; // +18..-2
          omni1 = omni1 + d.OMNI + balanceComponent;

          const thisBias = biasOfImpact(impact);
          if (thisBias === lastBias && thisBias !== 'balanced') {
            const nextStreak = biasStreak + 1;
            if (nextStreak >= 2) {
              omni1 -= DIFFICULTY.fatiguePenalty.omni;
              sat1  -= DIFFICULTY.fatiguePenalty.sat;
              ltv1  -= DIFFICULTY.fatiguePenalty.ltv;
              risk1 += DIFFICULTY.fatiguePenalty.risk;
            }
            setBiasStreak(nextStreak);
          } else {
            setBiasStreak(thisBias === 'balanced' ? 0 : 1);
            setLastBias(thisBias);
          }

          if (on1 > 95 && off1 < 60) { risk1 += 3; omni1 -= 3; }
          if (off1 > 95 && on1  < 60) { risk1 += 3; omni1 -= 3; }
          if (risk1 > 60) sat1 -= (risk1 - 60) * 0.08;
          if (risk1 > 75) ltv1 -= (risk1 - 75) * 0.20;

          const hardCap = (levelIndex < 3) ? 98 : 100;
          ltv1  = clamp(ltv1,  0, hardCap);
          sat1  = clamp(sat1,  0, hardCap);
          risk1 = clamp(risk1, 0, 100);
          omni1 = clamp(omni1, 0, hardCap);
          on1   = clamp(on1,  0, hardCap);
          off1  = clamp(off1, 0, hardCap);
          pop1  = clamp(pop1, 0, hardCap);
          mar1  = clamp(mar1, 0, hardCap);

          setLtv(ltv1); setSatisfaction(sat1); setRisk(risk1); setOnline(on1); setOffline(off1); setOmni(omni1); setPopularity(pop1); setMargin(mar1);
          fx.play('decision', 0.6, muted);
          setPendingAdvance(true);
        };

        const onChooseOnce = (impact, idx) => {
          if (selectedIndex !== null) return;
          setSelectedIndex(idx);
          applyImpact(impact);
        };

        const goNextLevel = () => {
          const moreLevels = levelIndex + 1 < LEVELS.length;
          if (moreLevels) {
            setLevelIndex(l => l + 1);
            setScenarioIndex(0);
            setSelectedIndex(null);
            setScreen('board');
          } else {
            setScreen('final');
          }
        };

        // Al terminar un campamento: 1 exclusivo + 1–2 contextuales
        const nextStep = () => {
          const moreScenarios = scenarioIndex + 1 < LEVELS[levelIndex].scenarios.length;
          if (moreScenarios) { setScenarioIndex(i => i + 1); setSelectedIndex(null); return; }

          const exclusive = EXCLUSIVE_EVENTS[levelIndex];
          const context = pickContextEvents(levelIndex, { popularity, risk, margin, omni, satisfaction }, lastBias, biasStreak);
          const queue = [exclusive, ...context].filter(Boolean);
          if(queue.length){ setEventQueue(queue); setEvent(queue[0]); }
          else { setMonth(m=>m+1); goNextLevel(); }
        };

        const resetGame = () => {
          setScreen('lobby'); setLevelIndex(0); setScenarioIndex(0); setEvent(null);
          setPendingAdvance(false); setSelectedIndex(null);
          setLtv(55); setOmni(35); setSatisfaction(72); setRisk(20); setOnline(45); setOffline(55);
          setPopularity(60); setMargin(55); setLastBias('balanced'); setBiasStreak(0); setMonth(1); setLog([]);
          try{ localStorage.removeItem('everest_react_state_v2'); }catch(e){}
        };

        const success = useMemo(() => {
          return Math.round( ltv*0.35 + satisfaction*0.30 + omni*0.20 + (100-risk)*0.15 );
        }, [ltv, satisfaction, omni, risk]);

        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <motion.div initial={{opacity:0,y:-10}} animate={{opacity:1,y:0}}>
                <h1 className="text-2xl md:text-3xl font-extrabold text-red-400 tracking-tight">
                  EVEREST CLIENTE — Demo Jugable (Static)
                </h1>
              </motion.div>
              <div className="flex items-center gap-3">
                <button className="btn btn-outline text-sm" onClick={() => setMuted(m => !m)}>
                  {muted ? '▶️ Sonido' : '⏸️ Silencio'}
                </button>
                <button className="btn btn-secondary text-sm" onClick={resetGame}>Reiniciar</button>
                <button className="btn btn-primary text-sm" onClick={() => setScreen('roles')}>Roles</button>
                <button className="btn btn-primary text-sm" onClick={() => setScreen('board')}>Tablero</button>
                <button className="btn btn-primary text-sm" onClick={() => setScreen('scenario')}>Escenario</button>
              </div>
            </div>

            <AnimatePresence mode="wait">
              {screen === 'lobby' && (
                <div className="card shadow-2xl">
                  <div className="text-center space-y-4 py-12 px-6">
                    <h2 className="text-4xl font-extrabold text-red-400">La Ascensión Omnicanal</h2>
                    <p className="text-gray-200/90 max-w-2xl mx-auto">
                      Une el Casino Online y las Salas Pause & Play para alcanzar el LTV máximo.
                      La cima se conquista en equipo.
                    </p>
                    <div className="flex justify-center gap-4 mt-4">
                      <button className="btn btn-primary" onClick={() => setScreen('roles')}>▶️ Iniciar Expedición</button>
                      <button className="btn btn-outline" onClick={() => setScreen('board')}>Explorar Tablero</button>
                    </div>
                  </div>
                </div>
              )}

              {screen === 'roles' && (
                <div className="card">
                  <div className="p-6">
                    <h2 className="text-2xl font-bold mb-6">Selecciona tu Rol</h2>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                      {[
                        {icon:'🎯',title:'Marketing',desc:'Captación y campañas'},
                        {icon:'💬',title:'CRM',desc:'Retención y personalización'},
                        {icon:'🧩',title:'Producto',desc:'UX e innovación'},
                        {icon:'🤝',title:'Locales',desc:'Sala física y omnicanalidad'},
                      ].map((r) => (
                        <div key={r.title} className="card border border-gray-600 text-center p-6">
                          <h3 className="text-xl mb-2">{r.icon} {r.title}</h3>
                          <p className="text-sm text-gray-300">{r.desc}</p>
                          <div className="mt-3 flex gap-2 justify-center">
                            <button className="btn btn-primary">Seleccionar</button>
                            <button className="btn btn-secondary" onClick={() => setScreen('board')}>Continuar</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {screen === 'board' && (
                <div>
                  <Board
                    levelIndex={levelIndex}
                    onStartScenario={() => setScreen('scenario')}
                    metrics={{ ltv, omni, satisfaction, risk, online, offline, popularity, margin }}
                    success={success}
                    log={log}
                  />
                </div>
              )}

              {screen === 'scenario' && (
                <div>
                  <ScenarioCard
                    levelTitle={LEVELS[levelIndex].title}
                    scenario={LEVELS[levelIndex].scenarios[scenarioIndex]}
                    onChoose={onChooseOnce}
                    selectedIndex={selectedIndex}
                  />
                  <HUD ltv={ltv} omni={omni} satisfaction={satisfaction} risk={risk} online={online} offline={offline} popularity={popularity} margin={margin} />
                  {pendingAdvance && (
                    <div className="flex justify-center mt-4">
                      <button className="btn btn-primary" onClick={() => { setPendingAdvance(false); nextStep(); }}>
                        Continuar ▶
                      </button>
                    </div>
                  )}
                </div>
              )}

              {event && (
                <EventModal
                  event={event}
                  onChoose={(impact) => {
                    onChooseOnce(impact, 0);
                    // Si este impacto trae un follow-up, lo inyectamos al inicio de la cola
                    const rest = eventQueue.slice(1);
                    if (impact && impact.__followup) {
                      rest.unshift(impact.__followup);
                    }
                    setLog(prev => [{ month, text: event.title + ' — decisión aplicada' }, ...prev].slice(0,120));
                    if(rest.length){ setEventQueue(rest); setEvent(rest[0]); setSelectedIndex(null); }
                    else { setEvent(null); setSelectedIndex(null); setMonth(m=>m+1); goNextLevel(); }
                  }}
                  onClose={() => {
                    setLog(prev => [{ month, text: event.title + ' — sin acción' }, ...prev].slice(0,120));
                    const rest = eventQueue.slice(1);
                    if(rest.length){ setEventQueue(rest); setEvent(rest[0]); setSelectedIndex(null); }
                    else { setEvent(null); setSelectedIndex(null); setMonth(m=>m+1); goNextLevel(); }
                  }}
                />
              )}

              {screen === 'final' && (
                <FinalScreen
                  score={success}
                  stats={{ ltv, omni, satisfaction, risk, online, offline }}
                  onRestart={resetGame}
                />
              )}
            </AnimatePresence>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>

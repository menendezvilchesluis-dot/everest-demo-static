<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Programa Everest — Juego + Simulador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Juego prototipo + simulador de variables del Programa Everest (casino)." />
  <style>
    :root { --card: 18 24 40; --ink: 245 246 248; }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.08); }
    .metric-shadow { box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    input[type="range"] { accent-color: #60a5fa; }
    .btn { @apply px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700; }
    .btn-primary { @apply px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-500; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-950 to-slate-900 text-slate-100">
  <header class="px-6 md:px-10 py-6 flex items-center justify-between">
    <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Programa <span class="text-blue-300">Everest</span> · Juego + Simulador</h1>
    <div class="flex items-center gap-2 text-xs md:text-sm">
      <button id="btnReset" class="btn">Restablecer</button>
      <button id="btnExport" class="btn-primary">Exportar JSON</button>
      <label class="btn cursor-pointer">Importar JSON
        <input id="fileImport" type="file" accept="application/json" class="hidden" />
      </label>
    </div>
  </header>

  <main class="px-6 md:px-10 pb-24">
    <!-- NAV -->
    <nav class="glass rounded-2xl p-2 inline-flex gap-2 text-sm mb-6">
      <button data-tab="juego" class="tab px-4 py-2 rounded-xl bg-blue-600">Juego</button>
      <button data-tab="simulador" class="tab px-4 py-2 rounded-xl hover:bg-slate-800">Simulador</button>
    </nav>

    <!-- JUEGO -->
    <section id="tab-juego" class="grid lg:grid-cols-3 gap-6">
      <!-- Panel estado del juego -->
      <div class="lg:col-span-2 glass rounded-3xl p-6 metric-shadow">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Operación diaria</h2>
          <div class="flex gap-2">
            <button id="btnTick" class="btn-primary">Avanzar 1 día</button>
            <button id="btnTick7" class="btn">Avanzar 7 días</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="rounded-2xl bg-slate-900 p-4">
            <div class="text-xs text-slate-400">Día</div>
            <div id="day" class="text-3xl font-bold">1</div>
          </div>
          <div class="rounded-2xl bg-slate-900 p-4">
            <div class="text-xs text-slate-400">Caja (€)</div>
            <div id="cash" class="text-3xl font-bold">0</div>
          </div>
          <div class="rounded-2xl bg-slate-900 p-4">
            <div class="text-xs text-slate-400">Jugadores activos</div>
            <div id="players" class="text-3xl font-bold">0</div>
          </div>
          <div class="rounded-2xl bg-slate-900 p-4">
            <div class="text-xs text-slate-400">Ingresos diarios estimados</div>
            <div id="revEst" class="text-3xl font-bold">0</div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="rounded-2xl bg-slate-900 p-4">
            <div class="text-xs text-slate-400">Reputación (Popularidad)</div>
            <div class="flex items-center gap-3">
              <div id="popVal" class="text-3xl font-bold">0</div>
              <div class="h-2 w-full rounded bg-slate-800 overflow-hidden"><div id="popBar" class="h-full bg-blue-500" style="width:0%"></div></div>
            </div>
          </div>
          <div class="rounded-2xl bg-slate-900 p-4">
            <div class="text-xs text-slate-400">Riesgo</div>
            <div class="flex items-center gap-3">
              <div id="riskVal" class="text-3xl font-bold">0</div>
              <div class="h-2 w-full rounded bg-slate-800 overflow-hidden"><div id="riskBar" class="h-full bg-blue-500" style="width:0%"></div></div>
            </div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="rounded-2xl bg-slate-900 p-4">
            <h3 class="font-semibold mb-2">Acciones rápidas</h3>
            <div class="flex flex-wrap gap-2 text-sm">
              <button class="btn" id="actOmni">Mejorar Omnicanalidad (+5) · Coste 10k€</button>
              <button class="btn" id="actAtencion">Mejorar Atención al cliente (+5 Satisf) · Coste 8k€</button>
              <button class="btn" id="actSeguridad">Reforzar Seguridad (−7 Riesgo) · Coste 6k€</button>
              <button class="btn" id="actBeneficios">Ajustar Beneficios (−5 Margen, +6 Satisf)</button>
            </div>
            <p class="text-xs text-slate-400 mt-2">Consejo: las acciones impactan las mismas variables que usa el simulador, todo está conectado.</p>
          </div>
          <div class="rounded-2xl bg-slate-900 p-4">
            <h3 class="font-semibold mb-2">Campañas</h3>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <button data-scenario="colaboradores" class="scenario btn">Sala con colaboradores (Coste 5k€)</button>
              <button data-scenario="tv" class="scenario btn">Campaña en TV (Coste 40k€)</button>
              <button data-scenario="twitch" class="scenario btn">Streamers en Twitch (Coste 15k€)</button>
              <button data-scenario="buscadores" class="scenario btn">Buscadores (Coste 8k€)</button>
            </div>
            <div id="scenarioNote" class="text-xs text-slate-400 mt-2 hidden"></div>
          </div>
        </div>

        <div class="mt-6 rounded-2xl bg-slate-900 p-4 max-h-64 overflow-auto">
          <h3 class="font-semibold mb-2">Eventos</h3>
          <ul id="log" class="text-sm space-y-2"></ul>
        </div>
      </div>

      <!-- Panel Éxito del Casino -->
      <div class="glass rounded-3xl p-6 metric-shadow">
        <h2 class="text-xl font-semibold mb-4">Éxito del Casino</h2>
        <div class="rounded-2xl bg-slate-900 p-5 grid gap-4">
          <div class="flex items-baseline justify-between">
            <div>
              <div class="text-5xl font-bold" id="exitoValue">0</div>
              <div class="text-xs text-slate-400">(0–100) · Promedio ponderado</div>
            </div>
            <div>
              <span id="exitoBadge" class="px-3 py-1 rounded-full text-xs bg-slate-800">–</span>
            </div>
          </div>
          <div class="text-xs text-slate-300 leading-relaxed">
            Fórmula: 0.30×Satisfacción + 0.25×Margen + 0.25×Popularidad + 0.20×(100 − Riesgo)
          </div>
          <div class="h-3 w-full rounded-full bg-slate-800 overflow-hidden">
            <div id="exitoBar" class="h-full bg-blue-500" style="width:0%"></div>
          </div>
        </div>

        <div class="mt-6 text-xs text-slate-300">
          <h3 class="font-semibold mb-2">Umbrales</h3>
          <ul class="list-disc ml-5 space-y-1">
            <li><b>&lt;40</b>: fracaso operativo</li>
            <li><b>40–60</b>: inestable</li>
            <li><b>60–75</b>: correcto</li>
            <li><b>75–90</b>: muy bueno</li>
            <li><b>&gt;90</b>: excelencia</li>
          </ul>
        </div>

        <div class="mt-6 rounded-2xl bg-slate-900 p-4">
          <h3 class="font-semibold mb-2">Desglose diario</h3>
          <ul class="text-sm" id="breakdown"></ul>
        </div>
      </div>
    </section>

    <!-- SIMULADOR -->
    <section id="tab-simulador" class="hidden">
      <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 glass rounded-3xl p-6 metric-shadow">
          <div class="flex items-start justify-between gap-4 mb-4">
            <h2 class="text-xl font-semibold">Variables del sistema</h2>
            <label class="flex items-center gap-2 text-xs"><input id="linkSO" type="checkbox" class="scale-110" checked> Vincular Sala ↔ Online</label>
          </div>
          <div id="controls" class="grid md:grid-cols-2 gap-5"></div>
        </div>
        <div class="glass rounded-3xl p-6 metric-shadow">
          <h2 class="text-xl font-semibold mb-4">Éxito del Casino</h2>
          <div class="rounded-2xl bg-slate-900 p-5 grid gap-4">
            <div class="flex items-baseline justify-between">
              <div>
                <div class="text-5xl font-bold" id="exitoValue2">0</div>
                <div class="text-xs text-slate-400">(0–100) · Promedio ponderado</div>
              </div>
              <div>
                <span id="exitoBadge2" class="px-3 py-1 rounded-full text-xs bg-slate-800">–</span>
              </div>
            </div>
            <div class="text-xs text-slate-300 leading-relaxed">
              Fórmula: 0.30×Satisfacción + 0.25×Margen + 0.25×Popularidad + 0.20×(100 − Riesgo)
            </div>
            <div class="h-3 w-full rounded-full bg-slate-800 overflow-hidden">
              <div id="exitoBar2" class="h-full bg-blue-500" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Leyenda de umbrales -->
      <section class="mt-8 grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="glass rounded-3xl p-5">
          <h3 class="font-semibold mb-3">Satisfacción del cliente</h3>
          <ul class="text-xs space-y-1 text-slate-300">
            <li>&lt;40: abandono</li>
            <li>40–50: muy mala</li>
            <li>50–60: mala</li>
            <li>80–90: buena</li>
            <li>&gt;90: excelente (recomienda)</li>
          </ul>
        </div>
        <div class="glass rounded-3xl p-5">
          <h3 class="font-semibold mb-3">Riesgo del cliente</h3>
          <ul class="text-xs space-y-1 text-slate-300">
            <li>&lt;30: bajo</li>
            <li>30–60: medio</li>
            <li>60–80: alto</li>
            <li>&gt;80: crítico</li>
          </ul>
        </div>
        <div class="glass rounded-3xl p-5">
          <h3 class="font-semibold mb-3">Popularidad</h3>
          <ul class="text-xs space-y-1 text-slate-300">
            <li>&lt;40: desconocido/mala imagen</li>
            <li>40–60: nicho</li>
            <li>60–80: notable</li>
            <li>80–90: popular</li>
            <li>&gt;90: fenómeno</li>
          </ul>
        </div>
        <div class="glass rounded-3xl p-5">
          <h3 class="font-semibold mb-3">Omnicanalidad</h3>
          <ul class="text-xs space-y-1 text-slate-300">
            <li>&lt;40: muy baja</li>
            <li>40–60: media</li>
            <li>60–80: buena</li>
            <li>&gt;80: excelente</li>
          </ul>
        </div>
        <div class="glass rounded-3xl p-5">
          <h3 class="font-semibold mb-3">Margen del casino</h3>
          <ul class="text-xs space-y-1 text-slate-300">
            <li>&lt;20: insostenible</li>
            <li>20–40: bajo</li>
            <li>40–60: correcto</li>
            <li>60–80: óptimo</li>
            <li>&gt;80: excelente (ojo satisfacción)</li>
          </ul>
        </div>
        <div class="glass rounded-3xl p-5">
          <h3 class="font-semibold mb-3">Sala / Online</h3>
          <ul class="text-xs space-y-1 text-slate-300">
            <li>Vinculados por defecto: Online = 100 − Sala</li>
            <li>Con alta omnicanalidad (&gt;80) el desbalance penaliza menos la satisfacción</li>
          </ul>
        </div>
      </section>
    </section>
  </main>

  <footer class="px-6 md:px-10 py-8 text-xs text-slate-400">
    Programa Everest · prototipo estático (index.html)
  </footer>

  <script>
    // ----------------------------
    // Modelo base del sistema (compartido Juego + Simulador)
    // ----------------------------
    const state = {
      Omnicanalidad: 55,
      Satisfaccion: 75,
      Riesgo: 35,
      Popularidad: 60,
      Margen: 55,
      Sala: 50,
      Online: 50,
      linkSO: true,
      // Juego
      day: 1,
      cash: 250000, // €
      players: 2000
    };

    const weights = { Satisfaccion: 0.30, Margen: 0.25, Popularidad: 0.25, Riesgo: 0.20 };

    // Deltas predefinidos para escenarios del Campamento Base
    const scenarios = {
      colaboradores: { label: 'Sala con colaboradores', cost: 5000, deltas: { Omnicanalidad: +10, Riesgo: -10, Popularidad: -5, Margen: +10, Sala: +10, Online: -10, Satisfaccion: +3 } },
      tv:            { label: 'Campaña en TV', cost: 40000, deltas: { Margen: -10, Omnicanalidad: -10, Riesgo: +10, Popularidad: +20, Satisfaccion: -5, Online: +5 } },
      twitch:        { label: 'Streamers en Twitch', cost: 15000, deltas: { Margen: -8, Riesgo: +12, Popularidad: +8, Satisfaccion: -3, Online: +10 } },
      buscadores:    { label: 'Buscadores en internet', cost: 8000, deltas: { Margen: +12, Riesgo: +5, Popularidad: +5, Satisfaccion: 0, Online: +12 } }
    };

    // ----------------------------
    // Utilidades
    // ----------------------------
    const clamp = (v, min=0, max=100) => Math.max(min, Math.min(max, v));
    const rnd = (a,b)=> Math.random()*(b-a)+a;

    function qualitative(key, value){
      switch(key){
        case 'Omnicanalidad': return value < 40 ? 'muy baja' : value < 60 ? 'media' : value < 80 ? 'buena' : 'excelente';
        case 'Satisfaccion': return value < 40 ? 'abandono' : value < 50 ? 'muy mala' : value < 60 ? 'mala' : value < 80 ? 'aceptable' : value < 90 ? 'buena' : 'excelente';
        case 'Riesgo': return value < 30 ? 'bajo' : value < 60 ? 'medio' : value < 80 ? 'alto' : 'crítico';
        case 'Popularidad': return value < 40 ? 'desconocido' : value < 60 ? 'nicho' : value < 80 ? 'notable' : value < 90 ? 'popular' : 'fenómeno';
        case 'Margen': return value < 20 ? 'insostenible' : value < 40 ? 'bajo' : value < 60 ? 'correcto' : value < 80 ? 'óptimo' : 'excelente';
        case 'Exito': return value < 40 ? 'fracaso' : value < 60 ? 'inestable' : value < 75 ? 'correcto' : value < 90 ? 'muy bueno' : 'excelencia';
      }
      return '';
    }

    function badgeColor(key, value){
      const ok = 'bg-emerald-600';
      const meh = 'bg-amber-500';
      const bad = 'bg-rose-600';
      switch(key){
        case 'Riesgo': return value < 60 ? ok : value < 80 ? meh : bad;
        case 'Satisfaccion': return value >= 80 ? ok : value >= 60 ? meh : bad;
        case 'Omnicanalidad': return value >= 60 ? ok : value >= 40 ? meh : bad;
        case 'Popularidad': return value >= 60 ? ok : value >= 40 ? meh : bad;
        case 'Margen': return value >= 60 ? ok : value >= 40 ? meh : bad;
        default: return 'bg-slate-700';
      }
    }

    function computeExito(){
      const { Satisfaccion, Margen, Popularidad, Riesgo } = state;
      const ex = (
        Satisfaccion * weights.Satisfaccion +
        Margen * weights.Margen +
        Popularidad * weights.Popularidad +
        (100 - Riesgo) * weights.Riesgo
      );
      return Math.round(ex);
    }

    function crossEffects(){
      if(state.Popularidad > 80){ state.Riesgo = clamp(state.Riesgo + 10); state.Margen = clamp(state.Margen - 5); }
      if(state.Margen > 80){ state.Satisfaccion = clamp(state.Satisfaccion - 10); }
      if(state.Omnicanalidad > 80){ state.Riesgo = clamp(state.Riesgo - 10); state.Satisfaccion = clamp(state.Satisfaccion + 5); }
      const imbalance = Math.abs(state.Sala - state.Online);
      if(imbalance > 40 && state.Omnicanalidad < 60){ state.Satisfaccion = clamp(state.Satisfaccion - 5); }
    }

    function save(){ try{ localStorage.setItem('everest_state', JSON.stringify(state)); }catch(e){} }
    function load(){ try{ const raw = localStorage.getItem('everest_state'); if(raw){ Object.assign(state, JSON.parse(raw)); } }catch(e){} }

    // ----------------------------
    // SIMULADOR UI
    // ----------------------------
    const controls = [
      { key:'Omnicanalidad', label:'Omnicanalidad' },
      { key:'Satisfaccion', label:'Satisfacción del cliente' },
      { key:'Riesgo', label:'Riesgo del cliente' },
      { key:'Popularidad', label:'Popularidad del casino' },
      { key:'Margen', label:'Margen del casino' },
      { key:'Sala', label:'Sala (peso % actividad)' },
      { key:'Online', label:'Online (peso % actividad)' },
    ];

    function renderControls(){
      const wrap = document.getElementById('controls');
      if(!wrap) return;
      wrap.innerHTML = '';
      controls.forEach(c => {
        const val = state[c.key];
        const card = document.createElement('div');
        card.className = 'rounded-2xl bg-slate-900 p-4';
        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <label class="font-medium">${c.label}</label>
            <span id="badge-${c.key}" class="px-2 py-1 rounded-full text-[10px] ${badgeColor(c.key, val)}">${qualitative(c.key, val)}</span>
          </div>
          <div class="flex items-center gap-3">
            <input id="range-${c.key}" type="range" min="0" max="100" step="1" value="${val}" class="w-full" />
            <div class="w-14 text-right text-sm tabular-nums" id="val-${c.key}">${val}</div>
          </div>
          <div class="h-2 w-full mt-2 rounded bg-slate-800 overflow-hidden">
            <div id="bar-${c.key}" class="h-full bg-blue-500" style="width:${val}%"></div>
          </div>
        `;
        wrap.appendChild(card);
        card.querySelector(`#range-${c.key}`).addEventListener('input', (e) => {
          const newVal = parseInt(e.target.value, 10);
          if(c.key === 'Sala' && document.getElementById('linkSO').checked){
            state.Sala = newVal; state.Online = clamp(100 - newVal); updateControl('Sala'); updateControl('Online');
          } else if(c.key === 'Online' && document.getElementById('linkSO').checked){
            state.Online = newVal; state.Sala = clamp(100 - newVal); updateControl('Online'); updateControl('Sala');
          } else {
            state[c.key] = newVal; updateControl(c.key);
          }
          updateAll(); syncGamePanel();
        });
      });
    }

    function updateControl(key){
      const v = clamp(state[key]); state[key] = v;
      const badge = document.getElementById(`badge-${key}`);
      const valEl = document.getElementById(`val-${key}`);
      const bar = document.getElementById(`bar-${key}`);
      const range = document.getElementById(`range-${key}`);
      if(badge){ badge.textContent = qualitative(key, v); badge.className = `px-2 py-1 rounded-full text-[10px] ${badgeColor(key, v)}`; }
      if(valEl) valEl.textContent = v;
      if(bar) bar.style.width = v + '%';
      if(range && parseInt(range.value,10) !== v){ range.value = v; }
    }

    function renderExito(domSuf=''){ // '' para juego, '2' para simulador
      const exito = computeExito();
      const badge = document.getElementById('exitoBadge'+domSuf);
      const bar = document.getElementById('exitoBar'+domSuf);
      const val = document.getElementById('exitoValue'+domSuf);
      if(val) val.textContent = exito;
      if(bar) bar.style.width = exito + '%';
      const q = qualitative('Exito', exito);
      if(badge){
        badge.textContent = q;
        badge.className = 'px-3 py-1 rounded-full text-xs ' + (exito>=75 ? 'bg-emerald-600' : exito>=60 ? 'bg-amber-500' : exito>=40 ? 'bg-yellow-700' : 'bg-rose-600');
      }
      return exito;
    }

    function updateAll(){
      // Vinculaciones
      const link = document.getElementById('linkSO');
      if(link) state.linkSO = link.checked;

      // Normaliza y aplica efectos cruzados sobre snapshot
      const snapshot = { ...state };
      ['Omnicanalidad','Satisfaccion','Riesgo','Popularidad','Margen','Sala','Online'].forEach(k=> state[k] = clamp(snapshot[k]));
      crossEffects();

      // Sync UI simulador
      controls.forEach(c => updateControl(c.key));
      renderExito('');
      renderExito('2');
      save();
    }

    function applyScenario(key, fromGame=false){
      const sc = scenarios[key]; if(!sc) return;
      const d = sc.deltas;
      for(const k in d){
        if(k === 'Sala' && document.getElementById('linkSO')?.checked){ state.Sala = clamp(state.Sala + d[k]); state.Online = clamp(100 - state.Sala); }
        else if(k === 'Online' && document.getElementById('linkSO')?.checked){ state.Online = clamp(state.Online + d[k]); state.Sala = clamp(100 - state.Online); }
        else { state[k] = clamp((state[k] ?? 0) + d[k]); }
      }
      if(fromGame){
        spend(sc.cost);
        log(`Campaña aplicada: <b>${sc.label}</b> (−€${fmt(sc.cost)})`);
      }
      const note = document.getElementById('scenarioNote');
      if(note){ note.classList.remove('hidden'); note.innerHTML = `Aplicado: ${sc.label}.`; }
      updateAll(); syncGamePanel();
      const bar = document.getElementById('exitoBar'); if(bar){ bar.classList.add('animate-pulse'); setTimeout(()=>bar.classList.remove('animate-pulse'), 600);}    
    }

    // ----------------------------
    // JUEGO: economía simple dependiente de variables
    // ----------------------------
    function expectedPlayers(){
      // Jugadores base escalados por Popularidad y Satisfacción; penalización por Riesgo alto
      const base = 1000 + state.Popularidad * 20; // 1000–3000
      const satFactor = 0.6 + (state.Satisfaccion/100)*0.8; // 0.6–1.4
      const riskPenalty = 1 - Math.max(0, (state.Riesgo - 50))/200; // 1 → 0.75
      const omniBoost = 1 + (state.Omnicanalidad>80 ? 0.1 : state.Omnicanalidad>60 ? 0.05 : 0);
      return Math.max(100, Math.round(base * satFactor * riskPenalty * omniBoost));
    }

    function estimateRevenue(players){
      // Ingreso unitario por canal (sala menor margen que online)
      const unitSala = 22; // € promedio día por jugador en sala
      const unitOnline = 28; // € online
      const salaShare = state.Sala/100;
      const onlineShare = state.Online/100;
      const gross = players * (unitSala*salaShare + unitOnline*onlineShare);
      const marginFactor = Math.max(0.1, state.Margen/100); // 0.1–1
      return Math.round(gross * marginFactor);
    }

    function estimateCosts(){
      // Costes: mayor sala, mayor coste; mayor riesgo → costes ocultos; omnicanalidad alta tiene coste mantenimiento
      const fixed = 20000; // nóminas, alquiler, etc.
      const salaCost = state.Sala * 120; // proporcional a peso sala
      const omniCost = state.Omnicanalidad>80 ? 6000 : state.Omnicanalidad>60 ? 3000 : 1000;
      const riskLeak = Math.max(0, state.Riesgo-50)*80; // fraudes, incidencias
      return Math.round(fixed + salaCost + omniCost + riskLeak);
    }

    function tickDay(){
      // Actualiza jugadores por tendencias y ruido
      const target = expectedPlayers();
      const delta = Math.round((target - state.players)*0.3 + rnd(-30, 30));
      state.players = Math.max(50, state.players + delta);
      // Ingresos y costes
      const revenue = estimateRevenue(state.players);
      const costs = estimateCosts();
      const net = revenue - costs;
      state.cash += net;
      state.day += 1;
      // Eventos aleatorios ligados a riesgo/popularidad
      randomEvent();
      // Actualiza UI
      syncGamePanel();
      updateAll();
      // Breakdown
      const bd = document.getElementById('breakdown');
      if(bd){
        bd.innerHTML = `
          <li>Ingresos: <b>€${fmt(revenue)}</b></li>
          <li>Costes: <b>€${fmt(costs)}</b></li>
          <li>Resultado diario: <b class="${net>=0?'text-emerald-400':'text-rose-400'}">€${fmt(net)}</b></li>
        `;
      }
    }

    function randomEvent(){
      const roll = Math.random();
      // Probabilidad de evento negativo aumenta con Riesgo, positivo con Popularidad/Satisfacción
      const pNeg = Math.min(0.6, 0.1 + state.Riesgo/200);
      const pPos = Math.min(0.5, 0.05 + (state.Popularidad+state.Satisfaccion)/400);
      if(roll < pNeg){
        const type = Math.random();
        if(type < 0.5){ state.cash -= 8000; state.Riesgo = clamp(state.Riesgo + 5); log('⚠️ Incidencia operativa: reparación urgente (−€8,000, +5 Riesgo)'); }
        else { state.Satisfaccion = clamp(state.Satisfaccion - 4); log('😕 Quejas en redes: baja la satisfacción (−4)'); }
      } else if(roll > 1 - pPos){
        const type = Math.random();
        if(type < 0.5){ state.cash += 6000; state.Popularidad = clamp(state.Popularidad + 4); log('🎉 Mini-viral en TikTok: +4 Popularidad, +€6,000'); }
        else { state.Satisfaccion = clamp(state.Satisfaccion + 5); log('😊 Buenas reseñas: +5 Satisfacción'); }
      }
    }

    function syncGamePanel(){
      const euro = v=> new Intl.NumberFormat('es-ES').format(v);
      document.getElementById('day').textContent = state.day;
      document.getElementById('cash').textContent = euro(state.cash);
      document.getElementById('players').textContent = state.players;
      const est = estimateRevenue(state.players);
      document.getElementById('revEst').textContent = euro(est);
      document.getElementById('popVal').textContent = state.Popularidad;
      document.getElementById('popBar').style.width = state.Popularidad+'%';
      document.getElementById('riskVal').textContent = state.Riesgo;
      document.getElementById('riskBar').style.width = state.Riesgo+'%';
    }

    function spend(amount){ state.cash -= amount; syncGamePanel(); }
    function fmt(n){ return new Intl.NumberFormat('es-ES').format(n); }

    function log(msg){
      const li = document.createElement('li');
      li.innerHTML = `<span class="text-slate-400">Día ${state.day}:</span> ${msg}`;
      const ul = document.getElementById('log');
      ul.prepend(li);
      // Limita log
      while(ul.children.length>100) ul.removeChild(ul.lastChild);
    }

    // ----------------------------
    // Inicialización y eventos UI
    // ----------------------------
    function init(){
      load();
      // Tabs
      document.querySelectorAll('.tab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.tab').forEach(b=> b.classList.remove('bg-blue-600'));
          btn.classList.add('bg-blue-600');
          const t = btn.dataset.tab;
          document.getElementById('tab-juego').classList.toggle('hidden', t!=='juego');
          document.getElementById('tab-simulador').classList.toggle('hidden', t!=='simulador');
        });
      });

      renderControls();
      updateAll();
      syncGamePanel();

      // Botones juego
      document.getElementById('btnTick').addEventListener('click', tickDay);
      document.getElementById('btnTick7').addEventListener('click', ()=>{ for(let i=0;i<7;i++) tickDay(); });

      document.getElementById('actOmni').addEventListener('click', ()=>{ if(state.cash<10000) return log('💸 Caja insuficiente para mejorar omnicanalidad'); state.Omnicanalidad = clamp(state.Omnicanalidad + 5); spend(10000); log('🔧 Mejoras omnicanalidad (+5)'); updateAll(); });
      document.getElementById('actAtencion').addEventListener('click', ()=>{ if(state.cash<8000) return log('💸 Caja insuficiente para mejorar atención'); state.Satisfaccion = clamp(state.Satisfaccion + 5); spend(8000); log('🤝 Mejora de atención al cliente (+5 Satisfacción)'); updateAll(); });
      document.getElementById('actSeguridad').addEventListener('click', ()=>{ if(state.cash<6000) return log('💸 Caja insuficiente para reforzar seguridad'); state.Riesgo = clamp(state.Riesgo - 7); spend(6000); log('🛡️ Seguridad reforzada (−7 Riesgo)'); updateAll(); });
      document.getElementById('actBeneficios').addEventListener('click', ()=>{ state.Margen = clamp(state.Margen - 5); state.Satisfaccion = clamp(state.Satisfaccion + 6); log('🎁 Mejores beneficios: −5 Margen, +6 Satisfacción'); updateAll(); });

      document.querySelectorAll('.scenario').forEach(btn => {
        btn.addEventListener('click', () => applyScenario(btn.dataset.scenario, true));
      });

      const link = document.getElementById('linkSO');
      if(link){
        link.checked = !!state.linkSO;
        link.addEventListener('change', ()=>{
          if(link.checked){ state.Online = clamp(100 - state.Sala); updateControl('Online'); }
          updateAll();
        });
      }

      // Export / Import / Reset
      document.getElementById('btnReset').addEventListener('click', () => {
        localStorage.removeItem('everest_state');
        Object.assign(state, { Omnicanalidad:55, Satisfaccion:75, Riesgo:35, Popularidad:60, Margen:55, Sala:50, Online:50, linkSO:true, day:1, cash:250000, players:2000 });
        renderControls(); updateAll(); syncGamePanel();
        const ul = document.getElementById('log'); ul.innerHTML='';
        const bd = document.getElementById('breakdown'); if(bd) bd.innerHTML = '';
      });

      document.getElementById('btnExport').addEventListener('click', () => {
        const data = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url; a.download = 'everest_state.json'; a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('fileImport').addEventListener('change', (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => { try{ const obj = JSON.parse(reader.result); Object.assign(state, obj); renderControls(); updateAll(); syncGamePanel(); log('📥 Estado importado.'); } catch(err){ alert('JSON inválido.'); } };
        reader.readAsText(file);
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pause & Play: Rumbo a la Cima</title>
    <link rel="icon" href="data:,">

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root { color-scheme: dark; }
      body { background: linear-gradient(to bottom, #111827, #0b0f19, #000); color: #fff; }
      .card { border: 1px solid #374151; background: rgba(31,41,55,0.7); border-radius: 1rem; }
      .progress { height: 8px; border-radius: 9999px; background: #374151; overflow: hidden }
      .progress > div { height: 100%; background: #ef4444; transition: width .25s ease; }
      .btn { border-radius: .75rem; font-weight: 600; padding: .6rem 1rem; }
      .btn-primary { background: #dc2626; } .btn-primary:hover { background: #b91c1c; }
      .btn-secondary { background: #374151; } .btn-outline { border: 1px solid #4b5563; }
      .btn-outline:hover { border-color: #ef4444; }
      .btn:disabled { opacity:.5; cursor:not-allowed; }
      .opt-picked { border-color:#f87171 !important; background:rgba(239,68,68,.08) !important; }
      .badge { font-size:.7rem; padding:.15rem .45rem; border:1px solid #4b5563; border-radius:.45rem; background:#111827; }
    </style>

    <!-- React + ReactDOM -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Framer Motion -->
    <script src="https://cdn.jsdelivr.net/npm/framer-motion/dist/framer-motion.umd.js"></script>

    <!-- Babel (JSX en navegador) -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div class="p-6 md:p-10"><div id="root"></div></div>

    <script type="text/babel" data-presets="react">
      const FM = window['framer-motion'] || {};
      const motion = FM.motion || new Proxy({}, { get: () => (props) => React.createElement('div', props) });
      const AnimatePresence = FM.AnimatePresence || (({children}) => children);

      const { useState, useMemo } = React;
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      const rnd = (n) => Math.round(n);

      // ============== Dificultad / EconomÃ­a (versiÃ³n endurecida) ==============
      const DIFFICULTY = {
        posScale: 0.6,
        negScale: 1.25,
        softCaps: {
          ltv:           [70, 78, 85, 92, 96, 100],
          satisfaction:  [80, 86, 90, 94, 97, 100],
          omni:          [68, 74, 80, 86, 92, 100], // Omni cap mÃ¡s bajo hasta etapa 5
          online:        [82, 88, 92, 95, 98, 100],
          offline:       [82, 88, 92, 95, 98, 100],
          popularity:    [85, 90, 94, 97, 99, 100],
          margin:        [78, 85, 90, 95, 98, 100],
        },
        fatiguePenalty: { omni: 6, sat: 4, ltv: 3, risk: 6 },
        diminishingStart: 70
      };

      const START = { ltv:55, omni:35, satisfaction:72, risk:20, online:45, offline:55, popularity:60, margin:55 };

      const softCapFor = (metric, levelIndex) => {
        const caps = DIFFICULTY.softCaps[metric] || [100,100,100,100,100,100];
        return caps[Math.min(levelIndex, caps.length-1)];
      };
      const applyPosWithCaps = (current, delta, cap) => {
        if (delta <= 0) return delta;
        let d = delta * DIFFICULTY.posScale;
        const start = DIFFICULTY.diminishingStart;
        if (current >= start) {
          const factor = clamp(1 - ((current - start) / (100 - start)), 0.15, 1);
          d *= factor;
        }
        if (current >= cap) d *= 0.15;
        else if (current + d > cap) d -= ((current + d) - cap) * 0.6;
        return d;
      };
      const applyNegWithDifficulty = (delta) => delta >= 0 ? delta : delta * DIFFICULTY.negScale;

      // Enfasis por etapa (multiplica impacto directo)
      const STAGE_WEIGHTS = [
        { omni:0.7,  on:0.8,  off:0.8,  risk:1.1, sat:1.2, mar:1.2, pop:1.4, ltv:1.0 }, // 0 CaptaciÃ³n
        { omni:0.8,  on:0.9,  off:0.9,  risk:1.1, sat:1.2, mar:1.2, pop:1.3, ltv:1.0 }, // 1 ActivaciÃ³n
        { omni:0.9,  on:1.3,  off:1.3,  risk:1.0, sat:1.1, mar:1.0, pop:1.0, ltv:1.1 }, // 2 RetenciÃ³n
        { omni:0.6,  on:0.8,  off:0.8,  risk:1.6, sat:1.0, mar:1.2, pop:0.9, ltv:1.0 }, // 3 Riesgo
        { omni:1.6,  on:1.5,  off:1.5,  risk:0.9, sat:1.2, mar:0.9, pop:0.9, ltv:1.1 }, // 4 FidelizaciÃ³n
        { omni:1.2,  on:1.1,  off:1.1,  risk:1.0, sat:1.1, mar:1.1, pop:1.1, ltv:1.2 }, // 5 ConsolidaciÃ³n
      ];
      // Topes por click (evita picos)
      const MAX_STEP = {
        omni: [3,3,4,5,6,10], on:[5,5,6,6,7,10], off:[5,5,6,6,7,10],
        sat:[4,5,5,5,6,8], risk:[6,6,6,8,6,6], mar:[4,5,5,6,5,6],
        pop:[6,6,5,4,4,6], ltv:[3,4,5,5,6,8]
      };
      const biasOfImpact = (impact) => {
        const on = impact.online ?? impact.online_activity ?? 0;
        const off = impact.offline ?? impact.offline_activity ?? 0;
        if (on - off > 6) return 'online';
        if (off - on > 6) return 'offline';
        return 'balanced';
      };

      // ======================= UI bÃ¡sicas =======================
      const ProgressBar = ({ value=0, color='#ef4444' }) => {
        const v = clamp(Math.round(value), 0, 100);
        return <div className="progress w-full"><div style={{width: v+'%', background: color}}></div></div>;
      };
      function HUD({ ltv, omni, satisfaction, risk, online, offline, popularity, margin }) {
        const items = [
          {label:'ğŸ’° LTV',val:rnd(ltv),color:'#22c55e'},
          {label:'ğŸ”„ Omnicanalidad',val:rnd(omni),isPct:true,color:'#60a5fa'},
          {label:'â¤ï¸ SatisfacciÃ³n',val:rnd(satisfaction),isPct:true,color:'#f97316'},
          {label:'âš ï¸ Riesgo',val:rnd(risk),isPct:true,color:'#ef4444'},
          {label:'ğŸ“£ Popularidad',val:rnd(popularity),isPct:true,color:'#eab308'},
          {label:'ğŸ“ˆ Margen',val:rnd(margin),isPct:true,color:'#10b981'},
          {label:'ğŸª Sala',val:rnd(offline),isPct:true,color:'#a78bfa'},
          {label:'ğŸ’» Online',val:rnd(online),isPct:true,color:'#34d399'}
        ];
        return (
          <div className="mt-6 grid sm:grid-cols-2 md:grid-cols-4 xl:grid-cols-8 gap-4">
            {items.map((m) => (
              <div key={m.label} className="card">
                <div className="p-4">
                  <p className="text-xs text-gray-300/80">{m.label}</p>
                  <div className="flex items-center gap-3 mt-2">
                    <ProgressBar value={m.val} color={m.color} />
                    <span className="text-sm text-gray-200 w-12 text-right">
                      {m.isPct?`${clamp(m.val,0,100)}%`:clamp(m.val,0,100)}
                    </span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        );
      }
      function SuccessPanel({ success }){
        const tag = success<40 ? 'fracaso' : success<60 ? 'inestable' : success<75 ? 'correcto' : success<90 ? 'muy bueno' : 'excelencia';
        const color = success>=90? '#16a34a' : success>=75? '#22c55e' : success>=60? '#f59e0b' : success>=40? '#fbbf24' : '#ef4444';
        return (
          <div className="card">
            <div className="p-5">
              <div className="flex items-baseline justify-between">
                <div>
                  <div className="text-4xl font-bold">{success}</div>
                  <div className="text-xs text-gray-300/80">Ã‰xito del Casino (0â€“100)</div>
                </div>
                <span className="badge" style={{borderColor:color,color}}>{tag}</span>
              </div>
              <div className="mt-3"><ProgressBar value={success} color={color} /></div>
            </div>
          </div>
        );
      }
      function TransitionTime({ months, onEnd }) {
        const labels = { 1:"ğŸ“… 1 mes despuÃ©s...", 3:"ğŸ“… 3 meses despuÃ©s...", 6:"ğŸ“… 6 meses despuÃ©s...", 9:"ğŸ“… 9 meses despuÃ©s...", 12:"ğŸ“… 1 aÃ±o despuÃ©s..." };
        return (
          <motion.div
            className="fixed inset-0 flex items-center justify-center bg-black/80 text-3xl md:text-4xl font-bold text-red-400 z-50"
            initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
            transition={{ duration: 1.2 }} onAnimationComplete={() => setTimeout(onEnd, 1000)}
          >
            {labels[months] || "ğŸ“… Tiempo despuÃ©s..."}
          </motion.div>
        );
      }

      // =================== Contenido (Etapas) ===================
      const LEVELS = [
        { key:"captacion", monthsAfter:1, title:"Etapa 1 â€” CaptaciÃ³n",
          bases:[
            { title:"Estrategias de captaciÃ³n", desc:"VÃ­as de captaciÃ³n de clientes para el Casino:",
              options:[
                { text:"CampaÃ±as SEO + SEM.", impact:{ margin:+4, risk:+1, popularity:+3, omni:+1, online:+2 } },
                { text:"Acuerdos con Streamers.", impact:{ margin:-3, risk:+3, popularity:+5, omni:+1, online:+3 } },
                { text:"CampaÃ±as de registro desde los locales.", impact:{ margin:+1, risk:+1, popularity:+2, omni:+4, offline:+3 } },
              ]},
            { title:"PromociÃ³n de bienvenida", desc:"PromociÃ³n que utilizaremos para potenciar los registros:",
              options:[
                { text:"200% de primer depÃ³sito.", impact:{ margin:-2, risk:+2, popularity:+4 } },
                { text:"20â‚¬ sin depÃ³sito.", impact:{ margin:-3, risk:+3, popularity:+3 } },
                { text:"Sin bono (Marca premium).", impact:{ margin:+3, risk:-2, popularity:-1 } },
              ]},
          ],
          event:{ title:"Â¡Necesitamos registros!", desc:"Quieres hacer push para potenciar registros durante un mes:",
            options:[
              { text:"CompeticiÃ³n de registros desde los locales con Ranking.", impact:{ popularity:+3, omni:+2, risk:+1, offline:+2 } },
              { text:"CampaÃ±a de Twitch con Streamer TOP.", impact:{ popularity:+4, margin:-2, risk:+2, online:+2 } },
              { text:"Sin evento (Ahorro).", impact:{ margin:+2 } },
            ]}
        },
        { key:"activacion", monthsAfter:3, title:"Etapa 2 â€” ActivaciÃ³n",
          bases:[
            { title:"Clientes registrados sin verificaciÃ³n", desc:"El 45% de los nuevos registros no han completado su verificaciÃ³n:",
              options:[
                { text:"Bloqueo de cuenta hasta su verificaciÃ³n.", impact:{ risk:-3, satisfaction:-3, popularity:-2 } },
                { text:"Activar promociones Ãºnicamente para clientes verificados.", impact:{ risk:-2, satisfaction:0, omni:+1 } },
                { text:"No intervenir y esperar acciÃ³n del cliente.", impact:{ risk:+3, satisfaction:-1 } },
              ]},
            { title:"Clientes activos sin primer depÃ³sito", desc:"Han jugado en demo o navegan la app, pero aÃºn no depositan:",
              options:[
                { text:"Estrategia de mailing con bono de bienvenida.", impact:{ margin:-1, popularity:+3 } },
                { text:"CampaÃ±a de urgencia â€œDeposita hoy y obtÃ©n un 300%â€.", impact:{ margin:-3, risk:+2, popularity:+4 } },
                { text:"Llamadas desde AtenciÃ³n al Cliente + Sala con promociÃ³n exclusiva.", impact:{ margin:-2, omni:+3, popularity:+2 } },
                { text:"No intervenir y esperar acciÃ³n del cliente.", impact:{ margin:+1, satisfaction:-2 } },
              ]},
          ],
          event:{ title:"Fallo en la web", desc:"Alira se cae 4h. No pueden verificar ni acceder al bono:",
            options:[
              { text:"Comunicar en web y publicar promociÃ³n en compensaciÃ³n.", impact:{ satisfaction:+4, margin:-2 } },
              { text:"PromociÃ³n solo a clientes molestos.", impact:{ satisfaction:+2, margin:-1 } },
              { text:"Ignorar y priorizar la campaÃ±a al reanudarse.", impact:{ risk:+3, satisfaction:-3 } },
            ]}
        },
        { key:"retencion", monthsAfter:6, title:"Etapa 3 â€” RetenciÃ³n",
          bases:[
            { title:"CaÃ­da de actividad tras el primer depÃ³sito", desc:"Baja el rendimiento tras la gran activaciÃ³n:",
              options:[
                { text:"Fiesta de Casino Online en los locales Pause&Play.", impact:{ offline:+3, omni:+2, popularity:+3, margin:-1 } },
                { text:"RediseÃ±o de la web para darle otro enfoque.", impact:{ online:+3, satisfaction:+3, margin:-2 } },
                { text:"Lanzamiento de la APP (inversiÃ³n alta, mejora a largo plazo).", impact:{ omni:+4, online:+3, margin:-3, satisfaction:+2 } },
              ]},
            { title:"Baja participaciÃ³n en promociones semanales", desc:"El ROI cae; buscamos reactivar interÃ©s:",
              options:[
                { text:"Segmentar por valor.", impact:{ satisfaction:+3, margin:-1 } },
                { text:"Duplicar promociones por tiempo limitado.", impact:{ satisfaction:+4, margin:-3, risk:+1 } },
                { text:"Nuevos formatos (desafÃ­os, minijuegos propios).", impact:{ satisfaction:+3, popularity:+3, margin:-2 } },
              ]},
          ],
          event:{ title:"Nuevo Lanzamiento", desc:"Proveedor TOP nos da su lanzamiento estrella en exclusiva:",
            options:[
              { text:"CampaÃ±a multicanal + posicionamiento premium web.", impact:{ popularity:+4, margin:-2, omni:+2 } },
              { text:"Lanzamiento anticipado 2 dÃ­as para VIP.", impact:{ satisfaction:+3, popularity:+2, margin:-1 } },
              { text:"FreeSpins exclusivos para clientes de locales.", impact:{ offline:+3, omni:+3, margin:-2 } },
            ]}
        },
        { key:"riesgo", monthsAfter:9, title:"Etapa 4 â€” Riesgo",
          bases:[
            { title:"Jugador intensivo Omnicanal", desc:"Sesiones muy largas + depÃ³sitos frecuentes:",
              options:[
                { text:"Estudio de riesgo y reducciÃ³n de privilegios si procede.", impact:{ risk:-4, satisfaction:-2 } },
                { text:"ComunicaciÃ³n responsable sobre juego seguro.", impact:{ risk:-2, satisfaction:0 } },
                { text:"Seguimiento discreto hasta patrones mÃ¡s fuertes.", impact:{ risk:-1, satisfaction:0 } },
              ]},
            { title:"Solicitud de exclusiÃ³n voluntaria", desc:"Cliente de alta actividad pide descanso:",
              options:[
                { text:"Bloqueo inmediato y solicitar autoexclusiÃ³n.", impact:{ risk:-3, satisfaction:-2 } },
                { text:"Contactar para analizar riesgos (nota en RGIAJ si procede).", impact:{ satisfaction:+1, risk:-2 } },
                { text:"Intento de disuasiÃ³n con bajada de lÃ­mites.", impact:{ risk:+2, margin:+1, satisfaction:-3 } },
              ]},
          ],
          event:{ title:"Nueva regulaciÃ³n", desc:"DGOJ exige pausas automÃ¡ticas y lÃ­mites por defecto mÃ¡s bajos:",
            options:[
              { text:"Adelantar cumplimiento.", impact:{ risk:-4, margin:-1, popularity:+1 } },
              { text:"Plan gradual: primero nuevos, luego resto.", impact:{ risk:-2, satisfaction:+1 } },
              { text:"Esperar al Ãºltimo dÃ­a.", impact:{ risk:+2, margin:+2 } },
            ]}
        },
        { key:"fidelizacion", monthsAfter:12, title:"Etapa 5 â€” FidelizaciÃ³n",
          bases:[
            { title:"Club VIP Omnicanal", desc:"Unificar beneficios para experiencia continua de alto valor:",
              options:[
                { text:"Modelo conjunto (puntos y perks cruzados).", impact:{ satisfaction:+3, omni:+4, margin:-1 } },
                { text:"Modelo espejo (fortalezas cruzadas por canal).", impact:{ satisfaction:+2, omni:+3 } },
                { text:"Modelo paralelo (preferencias por cliente).", impact:{ satisfaction:+1, margin:+1 } },
              ]},
            { title:"Beneficios y recompensas", desc:"Retener y motivar sin dependencia:",
              options:[
                { text:"Experiencias exclusivas (viajes, eventos, regalos).", impact:{ satisfaction:+4, popularity:+2, margin:-2 } },
                { text:"Recompensas web (cashback, misiones VIP, atenciÃ³n).", impact:{ satisfaction:+3, margin:-1, popularity:+1 } },
                { text:"Reconocimientos simbÃ³licos (trofeos, distintivos).", impact:{ satisfaction:+2, popularity:+1 } },
                { text:"BonificaciÃ³n agresiva (cashbacks altos continuos).", impact:{ satisfaction:+3, risk:+3, margin:-3 } },
              ]},
          ],
          event:{ title:"Â¡Quiero mi promociÃ³n!", desc:"No VIPs se quejan en redes por trato desigual:",
            options:[
              { text:"Transparencia y meritocracia (criterios de acceso).", impact:{ popularity:+2, satisfaction:+2 } },
              { text:"Crear niveles intermedios (plata/oro).", impact:{ satisfaction:+3, margin:-1 } },
              { text:"Mantener exclusividad (prestigio/diferenciaciÃ³n).", impact:{ satisfaction:-1, margin:+2 } },
            ]}
        },
        { key:"consolidacion", monthsAfter:0, title:"Etapa 6 â€” ConsolidaciÃ³n de Marca",
          bases:[
            { title:"Pause&PlayBet.es", desc:"Licencia AADD para apuestas deportivas; enfoque de lanzamiento:",
              options:[
                { text:"Nueva marca especÃ­fica solo de apuestas.", impact:{ popularity:+3, margin:-2, omni:+1 } },
                { text:"Integrar apuestas dentro del casino (marca Ãºnica).", impact:{ popularity:+2, omni:+3, margin:0 } },
                { text:"Submarca vinculada (pauseandplaybet.es).", impact:{ popularity:+3, margin:+1, omni:+2 } },
              ]},
            { title:"Experiencia Total Omnicanal", desc:"Terminales presenciales integradas con cuentas online:",
              options:[
                { text:"Instalar en todos los locales y comunicar salto tech.", impact:{ offline:+3, omni:+3, margin:-2 } },
                { text:"Piloto en centros estratÃ©gicos y escalar por resultados.", impact:{ offline:+2, omni:+2, margin:0 } },
                { text:"Priorizar comunidades con mayor madurez digital.", impact:{ omni:+3, margin:+1, risk:-1 } },
              ]},
          ],
          event:{ title:"Siguientes pasos", desc:"Cima nacional lograda; siguiente rumbo:",
            options:[
              { text:"Expandir a otros paÃ­ses (modelo omnicanal).", impact:{ popularity:+4, risk:+2, margin:-2 } },
              { text:"Innovar experiencia (IA, VR, streaming).", impact:{ satisfaction:+4, risk:+1, margin:-1 } },
              { text:"Diversificar ocio bajo el sello Pause&Play.", impact:{ margin:+3, risk:0, popularity:+2 } },
            ]}
        },
      ];

      // =================== Motor con Ã©nfasis y trade-offs ===================
      function applyImpactToState(state, impact, levelIndex, lastBias, biasStreak) {
        const w = STAGE_WEIGHTS[Math.min(levelIndex, STAGE_WEIGHTS.length-1)];
        const dRaw = {
          ltv: impact.LTV ?? 0,
          sat: impact.satisfaction ?? 0,
          risk: impact.risk ?? 0,
          omni: impact.omni ?? impact.omnichannel_index ?? 0,
          on: impact.online ?? impact.online_activity ?? 0,
          off: impact.offline ?? impact.offline_activity ?? 0,
          pop: impact.popularity ?? 0,
          mar: impact.margin ?? 0
        };
        const d = {
          ltv: dRaw.ltv * w.ltv, sat: dRaw.sat * w.sat, risk: dRaw.risk * w.risk,
          omni: dRaw.omni * w.omni, on: dRaw.on * w.on, off: dRaw.off * w.off,
          pop: dRaw.pop * w.pop, mar: dRaw.mar * w.mar
        };
        const caps = {
          ltv: softCapFor('ltv', levelIndex), sat: softCapFor('satisfaction', levelIndex),
          omni: softCapFor('omni', levelIndex), on: softCapFor('online', levelIndex),
          off: softCapFor('offline', levelIndex), pop: softCapFor('popularity', levelIndex),
          mar: softCapFor('margin', levelIndex),
        };
        const pos = (cur, v, cap) => v <= 0 ? v : applyPosWithCaps(cur, v, cap);
        const neg = (v) => v >= 0 ? v : applyNegWithDifficulty(v);

        let s = { ...state };
        const dApplied = { ltv:0,sat:0,on:0,off:0,pop:0,mar:0,omni:0,risk:0 };

        dApplied.ltv = (d.ltv>=0) ? pos(s.ltv, d.ltv, caps.ltv) : neg(d.ltv); s.ltv += dApplied.ltv;
        dApplied.sat = (d.sat>=0) ? pos(s.satisfaction, d.sat, caps.sat) : neg(d.sat); s.satisfaction += dApplied.sat;
        dApplied.on  = (d.on>=0)  ? pos(s.online, d.on, caps.on) : neg(d.on); s.online += dApplied.on;
        dApplied.off = (d.off>=0) ? pos(s.offline, d.off, caps.off) : neg(d.off); s.offline += dApplied.off;
        dApplied.pop = (d.pop>=0) ? pos(s.popularity, d.pop, caps.pop) : neg(d.pop); s.popularity += dApplied.pop;
        dApplied.mar = (d.mar>=0) ? pos(s.margin, d.mar, caps.mar) : neg(d.mar); s.margin += dApplied.mar;

        dApplied.risk = (d.risk>=0) ? d.risk*1.1 : d.risk*1.2; s.risk += dApplied.risk;

        // Omnicanalidad = impacto explÃ­cito + balance de canales (suave) + tope por click
        const gap = Math.abs(s.online - s.offline);
        let omniDelta = 0;
        if (d.omni !== 0) omniDelta += (d.omni>=0) ? applyPosWithCaps(s.omni, d.omni, caps.omni) : applyNegWithDifficulty(d.omni);
        const balanceBase = (levelIndex <= 1) ? 2 : (levelIndex === 2 ? 3 : (levelIndex === 3 ? 3.5 : (levelIndex === 4 ? 4 : 5)));
        const balanceSlope = (levelIndex <= 1) ? 0.10 : (levelIndex === 2 ? 0.12 : (levelIndex === 3 ? 0.14 : (levelIndex === 4 ? 0.16 : 0.18)));
        omniDelta += (balanceBase - gap * balanceSlope);
        const omniMaxStep = MAX_STEP.omni[Math.min(levelIndex, MAX_STEP.omni.length-1)];
        if (omniDelta > omniMaxStep) omniDelta = omniMaxStep;
        s.omni += omniDelta; dApplied.omni = omniDelta;

        // Trade-offs
        if (dApplied.sat > 0) s.margin -= dApplied.sat * 0.25;
        if (dApplied.pop > 0) s.risk += dApplied.pop * 0.35;
        if (dApplied.mar > 0) { s.satisfaction -= dApplied.mar * 0.2; s.popularity -= dApplied.mar * 0.1; }
        if (dApplied.omni > 0) { s.margin -= dApplied.omni * 0.15; s.satisfaction -= Math.max(0, dApplied.omni-2) * 0.05; }

        // Riesgo dinÃ¡mico por crecimiento "no controlado"
        const growthPos = Math.max(0, dApplied.pop) + Math.max(0, dApplied.sat) + Math.max(0, dApplied.mar);
        const growthCtrl = Math.max(0, dApplied.omni) + Math.max(0, dApplied.on) + Math.max(0, dApplied.off);
        if (growthPos - growthCtrl > 0) s.risk += (growthPos - growthCtrl) * 0.15;

        // Fatiga de canal
        const thisBias = biasOfImpact(dRaw);
        let nextBias = lastBias, nextStreak = biasStreak;
        if (thisBias !== 'balanced') {
          if (thisBias === lastBias) nextStreak += 1; else { nextBias = thisBias; nextStreak = 1; }
          if (nextStreak >= 2) { s.omni -= DIFFICULTY.fatiguePenalty.omni; s.satisfaction -= DIFFICULTY.fatiguePenalty.sat; s.ltv -= DIFFICULTY.fatiguePenalty.ltv; s.risk += DIFFICULTY.fatiguePenalty.risk; }
        } else { nextBias = 'balanced'; nextStreak = 0; }

        // Castigos por riesgo alto
        if (s.risk > 60) s.satisfaction -= (s.risk - 60) * 0.08;
        if (s.risk > 75) s.ltv -= (s.risk - 75) * 0.18;

        // Bono de madurez en Etapa 6 si el core medio estÃ¡ entre 75â€“85
        if (levelIndex === 5) {
          const coreAvg = (s.ltv + s.satisfaction + s.omni + (100 - s.risk)) / 4;
          if (coreAvg >= 75 && coreAvg <= 85) { s.ltv += 3; s.satisfaction += 3; s.omni += 3; s.risk -= 3; }
        }

        // Hard caps
        const hardCap = levelIndex < 4 ? 95 : 100;
        s.ltv = clamp(s.ltv, 0, hardCap); s.satisfaction = clamp(s.satisfaction, 0, hardCap);
        s.omni = clamp(s.omni, 0, hardCap); s.online = clamp(s.online, 0, hardCap);
        s.offline = clamp(s.offline, 0, hardCap); s.popularity = clamp(s.popularity, 0, hardCap);
        s.margin = clamp(s.margin, 0, hardCap); s.risk = clamp(s.risk, 0, 100);

        return { state: s, bias: nextBias, streak: nextStreak };
      }

      // =================== UI: Escenario / Evento ===================
      function ScenarioCard({ stageTitle, base, onChoose, selectedIndex }) {
        return (
          <div className="card">
            <div className="p-6 space-y-4">
              <p className="text-sm text-gray-300/90 uppercase tracking-wider">{stageTitle}</p>
              <h3 className="text-2xl md:text-3xl font-semibold text-red-400">{base.title}</h3>
              {base.desc && <p className="text-gray-200/90">{base.desc}</p>}
              <div className="grid md:grid-cols-2 gap-3">
                {base.options.map((opt, i) => {
                  const picked = selectedIndex === i;
                  return (
                    <button
                      key={i}
                      className={`btn btn-outline text-left ${picked ? 'opt-picked' : ''}`}
                      disabled={selectedIndex !== null && !picked}
                      onClick={() => onChoose(opt, i)}
                    >
                      {opt.text} {picked && 'âœ“'}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }
      function EventModal({ event, onChoose, onClose }) {
        if (!event) return null;
        return (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
            <div className="w-full max-w-xl">
              <div className="card" style={{borderColor:'#f59e0b'}}>
                <div className="p-6">
                  <h3 className="text-xl md:text-2xl font-bold text-yellow-400">{event.title}</h3>
                  <p className="text-gray-200 mt-2">{event.desc}</p>
                  <div className="grid gap-3 mt-4">
                    {event.options.map((opt, i) => (
                      <button key={i} className="btn btn-secondary text-left" style={{background:'#f59e0b',color:'#000'}} onClick={() => onChoose(opt)}>
                        {opt.text}
                      </button>
                    ))}
                  </div>
                  <div className="mt-3">
                    <button className="btn btn-outline" onClick={onClose}>Cerrar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // =============== UI: Board con "Mapa de Etapas" (SVG) ===============
      function StageMap({ current }) {
        // puntos predefinidos (como el boceto)
        const points = [
          {x:80,y:260},{x:240,y:220},{x:400,y:260},{x:560,y:210},{x:720,y:160},{x:880,y:90}
        ];
        const pathD = `M ${points[0].x},${points[0].y}
          C 160,240 200,220 ${points[1].x},${points[1].y}
          S ${points[2].x},${points[2].y} ${points[3].x},${points[3].y}
          S ${points[4].x},${points[4].y} ${points[5].x},${points[5].y}`;
        return (
          <svg viewBox="0 0 980 320" className="w-full h-[260px] md:h-[320px]">
            <path d={pathD} fill="none" stroke="#64748b" strokeWidth="6" strokeLinecap="round" opacity="0.5"/>
            {points.map((p,i)=>(
              <g key={i} transform={`translate(${p.x} ${p.y})`}>
                <circle r="28" fill={i<=current ? "#ef4444" : "#475569"} />
                <text textAnchor="middle" y="6" fontSize="18" fill="#fff" fontWeight="700">{i+1}</text>
              </g>
            ))}
          </svg>
        );
      }
      function Board({ level, levelIndex, state, success, onOpenScenario }) {
        return (
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 card">
              <div className="p-8">
                <h1 className="text-4xl md:text-5xl font-extrabold tracking-tight">
                  PAUSE &amp; PLAY: <span className="text-red-400">Rumbo a la Cima</span>
                </h1>

                <div className="mt-2 text-gray-300 flex items-center gap-3">
                  <span className="text-2xl">ğŸ”ï¸</span>
                  <div>
                    <div className="text-2xl md:text-3xl font-bold">
                      {level.title.replace('Etapa', 'Etapa')}
                    </div>
                  </div>
                </div>

                <div className="mt-4">
                  <StageMap current={levelIndex}/>
                </div>

                <div className="mt-2">
                  <button className="btn btn-primary" onClick={onOpenScenario}>Abrir escenario</button>
                </div>
              </div>
            </div>

            <div className="flex flex-col gap-6">
              <div className="card">
                <div className="p-6">
                  <div className="text-5xl font-extrabold">{success}</div>
                  <div className="text-sm text-gray-300/90 mt-1">Ã‰xito del Casino (0â€“100)</div>
                  <div className="mt-3"><ProgressBar value={success} color="#f59e0b" /></div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="card"><div className="p-4"><div className="text-sm text-gray-300">ğŸ’° LTV</div><div className="text-2xl font-bold">{rnd(state.ltv)}</div></div></div>
                <div className="card"><div className="p-4"><div className="text-sm text-gray-300">ğŸ”„ Omnicanalidad</div><div className="text-2xl font-bold">{rnd(state.omni)}%</div></div></div>
                <div className="card"><div className="p-4"><div className="text-sm text-gray-300">âš ï¸ Riesgo</div><div className="text-2xl font-bold">{rnd(state.risk)}%</div></div></div>
                <div className="card"><div className="p-4"><div className="text-sm text-gray-300">ğŸ’» Online</div><div className="text-2xl font-bold">{rnd(state.online)}%</div></div></div>
              </div>
            </div>
          </div>
        );
      }

      const FinalScreen = ({ score, stats, onRestart }) => (
        <div className="card">
          <div className="text-center space-y-4 py-12 px-6">
            <div className="text-5xl">ğŸ</div>
            <h2 className="text-3xl md:text-4xl font-extrabold text-red-400">Â¡Cima alcanzada!</h2>
            <p className="text-gray-200 text-lg">PuntuaciÃ³n final: <span className="font-bold">{score}</span></p>
            <div className="grid md:grid-cols-3 gap-3 text-sm text-gray-200 max-w-3xl mx-auto">
              <div className="bg-white/5 p-3 rounded-xl">LTV: <b>{rnd(stats.ltv)}</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Omnicanalidad: <b>{rnd(stats.omni)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">SatisfacciÃ³n: <b>{rnd(stats.satisfaction)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Riesgo: <b>{rnd(stats.risk)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Sala: <b>{rnd(stats.offline)}%</b></div>
              <div className="bg-white/5 p-3 rounded-xl">Online: <b>{rnd(stats.online)}%</b></div>
            </div>
            <div className="flex justify-center gap-4 mt-4"><button className="btn btn-secondary" onClick={onRestart}>ğŸ” Reiniciar</button></div>
          </div>
        </div>
      );

      // ======================= App =======================
      function App() {
        const [screen, setScreen] = useState('board');
        const [levelIndex, setLevelIndex] = useState(0);
        const [baseIndex, setBaseIndex] = useState(0);
        const [selectedIndex, setSelectedIndex] = useState(null);
        const [eventOpen, setEventOpen] = useState(false);
        const [showTransition, setShowTransition] = useState(false);
        const [transitionMonths, setTransitionMonths] = useState(0);

        const [state, setState] = useState({ ...START });
        const [lastBias, setLastBias] = useState('balanced');
        const [biasStreak, setBiasStreak] = useState(0);

        const success = useMemo(() => {
          return Math.round( state.ltv*0.35 + state.satisfaction*0.30 + state.omni*0.20 + (100-state.risk)*0.15 );
        }, [state]);

        const level = LEVELS[levelIndex];

        const chooseOption = (opt, idx) => {
          if (selectedIndex !== null) return;
          setSelectedIndex(idx);
          const res = applyImpactToState(state, opt.impact || {}, levelIndex, lastBias, biasStreak);
          setState(res.state); setLastBias(res.bias); setBiasStreak(res.streak);
        };

        const nextStep = () => {
          const moreBases = baseIndex + 1 < level.bases.length;
          if (moreBases) { setBaseIndex(baseIndex + 1); setSelectedIndex(null); return; }
          if (!eventOpen) { setEventOpen(true); return; }
        };

        const afterEvent = () => {
          setEventOpen(false);
          const months = LEVELS[levelIndex]?.monthsAfter ?? 0;
          if (months > 0 && levelIndex < LEVELS.length - 1) {
            setTransitionMonths(months);
            setShowTransition(true);
            setTimeout(() => setShowTransition(false), 2000);
          }
          const more = levelIndex + 1 < LEVELS.length;
          if (more) {
            setTimeout(() => { setLevelIndex(levelIndex + 1); setBaseIndex(0); setSelectedIndex(null); setScreen('board'); }, 2000);
          } else {
            setTimeout(() => setScreen('final'), 1200);
          }
        };

        const resetGame = () => {
          setScreen('board'); setLevelIndex(0); setBaseIndex(0); setSelectedIndex(null);
          setEventOpen(false); setShowTransition(false); setTransitionMonths(0);
          setState({ ...START }); setLastBias('balanced'); setBiasStreak(0);
        };

        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <motion.div initial={{opacity:0,y:-10}} animate={{opacity:1,y:0}}>
                <h2 className="text-xl md:text-2xl font-semibold text-gray-300">Demo Jugable</h2>
              </motion.div>
              <div className="flex items-center gap-3">
                <button className="btn btn-secondary text-sm" onClick={resetGame}>Reiniciar</button>
                <button className={`btn btn-primary text-sm ${screen==='board'?'opacity-60':''}`} onClick={()=>setScreen('board')}>Tablero</button>
                <button className={`btn btn-primary text-sm ${screen==='scenario'?'opacity-60':''}`} onClick={()=>setScreen('scenario')}>Escenario</button>
              </div>
            </div>

            <AnimatePresence mode="wait">
              {screen === 'board' && (
                <Board
                  level={level}
                  levelIndex={levelIndex}
                  state={state}
                  success={success}
                  onOpenScenario={()=>setScreen('scenario')}
                />
              )}

              {screen === 'scenario' && (
                <div>
                  <div className="card mb-4">
                    <div className="p-6">
                      <h2 className="text-2xl md:text-3xl font-bold mb-2">{level.title}</h2>
                      <p className="text-sm text-gray-300">Base {baseIndex+1} de {level.bases.length}</p>
                    </div>
                  </div>

                  <ScenarioCard
                    stageTitle={level.title}
                    base={level.bases[baseIndex]}
                    onChoose={chooseOption}
                    selectedIndex={selectedIndex}
                  />
                  <HUD
                    ltv={state.ltv} omni={state.omni} satisfaction={state.satisfaction} risk={state.risk}
                    online={state.online} offline={state.offline} popularity={state.popularity} margin={state.margin}
                  />
                  {selectedIndex!==null && (
                    <div className="flex justify-center mt-4">
                      <button className="btn btn-primary" onClick={nextStep}>Continuar â–¶</button>
                    </div>
                  )}
                </div>
              )}

              {screen === 'final' && (
                <FinalScreen score={success} stats={state} onRestart={resetGame} />
              )}
            </AnimatePresence>

            <EventModal
              event={eventOpen ? level.event : null}
              onChoose={(opt)=>{
                const res = applyImpactToState(state, opt.impact || {}, levelIndex, lastBias, biasStreak);
                setState(res.state); setLastBias(res.bias); setBiasStreak(res.streak);
                afterEvent();
              }}
              onClose={afterEvent}
            />

            {showTransition && <TransitionTime months={transitionMonths} onEnd={()=>{}} />}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
